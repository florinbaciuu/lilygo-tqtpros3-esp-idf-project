<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-73KGWFC8DM"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-73KGWFC8DM');
        </script><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lwIP - ESP32 -  &mdash; ESP-IDF Programming Guide v5.4.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=a60756f2" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=949a1ff5" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=851bd809" />

  
    <link rel="canonical" href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-guides/lwip.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=c241bbaf"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=ff8fa330"></script>
        <script src="https://wavedrom.com/skins/default.js"></script>
        <script src="https://wavedrom.com/wavedrom.min.js"></script>
    <script src="../_static/js/theme.js"></script>

    
        

    <script type="text/javascript">
        DOCUMENTATION_OPTIONS.PAGENAME = 'api-guides/lwip';
        DOCUMENTATION_OPTIONS.PROJECT_SLUG = 'esp-idf';
        DOCUMENTATION_OPTIONS.LATEST_BRANCH_NAME = 'master';
        DOCUMENTATION_OPTIONS.VERSIONS_URL = 'https://dl.espressif.com/dl/esp-idf/idf_versions.js';
        DOCUMENTATION_OPTIONS.LANGUAGES = ["en", "zh_CN"];
        DOCUMENTATION_OPTIONS.IDF_TARGET = 'esp32';
        DOCUMENTATION_OPTIONS.HAS_IDF_TARGETS = ["esp32", "esp32s2", "esp32s3", "esp32c3", "esp32c2", "esp32c5", "esp32c6", "esp32p4"]
        DOCUMENTATION_OPTIONS.RELEASE = 'v5.4.2';
        DOCUMENTATION_OPTIONS.LANGUAGE_URL = 'en';

    </script>

    <script type="text/javascript" src="https://dl.espressif.com/dl/esp-idf/idf_versions.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Memory Types" href="memory-types.html" />
    <link rel="prev" title="Introduction to Low Power Mode in Wi-Fi Scenarios" href="low-power-mode/low-power-mode-wifi.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ESP-IDF Programming Guide
              <img src="../_static/espressif-logo.svg" class="logo" alt="Logo"/>
          </a>

          
            <div class="selectors">
              <select id="target-select" style="width: 150px;" hidden>
                <option value="" disabled selected>Choose target...</option>
              </select>
            </div>
          

          <div class="selectors">
            <select id="version-select" style="width: 150px;" hidden>
              <option value="" disabled selected>Choose version...</option>
            </select>
          </div>

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../get-started/index.html">Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hw-reference/index.html">Hardware Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">API Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="app_trace.html">Application Level Tracing Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="startup.html">Application Startup Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="classic-bt/index.html">Bluetooth<sup>®</sup> Classic</a></li>
<li class="toctree-l2"><a class="reference internal" href="ble/index.html">Bluetooth<sup>®</sup> Low Energy</a></li>
<li class="toctree-l2"><a class="reference internal" href="esp-ble-mesh/ble-mesh-index.html">ESP-BLE-MESH</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootloader.html">Bootloader</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-system.html">Build System</a></li>
<li class="toctree-l2"><a class="reference internal" href="coexist.html">RF Coexistence</a></li>
<li class="toctree-l2"><a class="reference internal" href="c.html">C Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="cplusplus.html">C++ Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="code-quality/index.html">Code Quality</a></li>
<li class="toctree-l2"><a class="reference internal" href="core_dump.html">Core Dump</a></li>
<li class="toctree-l2"><a class="reference internal" href="current-consumption-measurement-modules.html">Current Consumption Measurement of Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="deep-sleep-stub.html">Deep-sleep Wake Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="error-handling.html">Error Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="esp-wifi-mesh.html">ESP-WIFI-MESH</a></li>
<li class="toctree-l2"><a class="reference internal" href="external-ram.html">Support for External RAM</a></li>
<li class="toctree-l2"><a class="reference internal" href="fatal-errors.html">Fatal Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="file-system-considerations.html">File System Considerations</a></li>
<li class="toctree-l2"><a class="reference internal" href="hardware-abstraction.html">Hardware Abstraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="hlinterrupts.html">High Priority Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="jtag-debugging/index.html">JTAG Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="linker-script-generation.html">Linker Script Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="low-power-mode/index.html">Low Power Modes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">lwIP</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#supported-apis">Supported APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adapted-apis">Adapted APIs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#bsd-sockets-api">BSD Sockets API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#references">References</a></li>
<li class="toctree-l4"><a class="reference internal" href="#application-examples">Application Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="#supported-functions">Supported Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#socket-error-handling">Socket Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#socket-options">Socket Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fcntl"><code class="docutils literal notranslate"><span class="pre">fcntl()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#ioctl"><code class="docutils literal notranslate"><span class="pre">ioctl()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#netconn-api">Netconn API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lwip-freertos-task">lwIP FreeRTOS Task</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ipv6-support">IPv6 Support</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#stateless-autoconfiguration-process">Stateless Autoconfiguration Process</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dhcpv6">DHCPv6</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dns-servers-in-ipv6-autoconfiguration">DNS Servers in IPv6 Autoconfiguration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#esp-lwip-custom-modifications">ESP-lwIP Custom Modifications</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#additions">Additions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#performance-optimization">Performance Optimization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#maximum-throughput">Maximum Throughput</a></li>
<li class="toctree-l4"><a class="reference internal" href="#minimum-latency">Minimum Latency</a></li>
<li class="toctree-l4"><a class="reference internal" href="#minimum-ram-usage">Minimum RAM Usage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="memory-types.html">Memory Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="openthread.html">OpenThread</a></li>
<li class="toctree-l2"><a class="reference internal" href="partition-tables.html">Partition Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance/index.html">Performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="reproducible-builds.html">Reproducible Builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="RF_calibration.html">RF Calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="stdio.html">Standard I/O and Console Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="thread-local-storage.html">Thread Local Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools/index.html">Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit-tests.html">Unit Testing in ESP32</a></li>
<li class="toctree-l2"><a class="reference internal" href="host-apps.html">Running ESP-IDF Applications on Host</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi.html">Wi-Fi Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi-security.html">Wi-Fi Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi-expansion.html">Wi-Fi Expansion</a></li>
<li class="toctree-l2"><a class="reference internal" href="phy.html">PHY</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration-guides/index.html">Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../libraries-and-frameworks/index.html">Libraries and Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contributions Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">ESP-IDF Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COPYRIGHT.html">Copyrights and Licenses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages.html">Switch Between Languages</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ESP-IDF Programming Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">API Guides</a></li>
      <li class="breadcrumb-item active">lwIP</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/espressif/esp-idf/blob/v5.4.2/docs/en/api-guides/lwip.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="lwip">
<h1>lwIP<a class="headerlink" href="#lwip" title="Permalink to this heading"></a></h1>
<p><a class="reference external" href="../../../../zh_CN/v5.4.2/esp32/api-guides/lwip.html">[中文]</a></p>
<p>ESP-IDF uses the open source <a class="reference external" href="https://savannah.nongnu.org/projects/lwip/">lwIP lightweight TCP/IP stack</a>. The ESP-IDF version of lwIP (<a class="reference external" href="https://github.com/espressif/esp-lwip">esp-lwip</a>) has some modifications and additions compared to the upstream project.</p>
<section id="supported-apis">
<h2>Supported APIs<a class="headerlink" href="#supported-apis" title="Permalink to this heading"></a></h2>
<p>ESP-IDF supports the following lwIP TCP/IP stack functions:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#bsd-sockets-api">BSD Sockets API</a></p></li>
<li><p><a class="reference internal" href="#netconn-api">Netconn API</a> is enabled but not officially supported for ESP-IDF applications</p></li>
</ul>
<section id="adapted-apis">
<span id="lwip-dns-limitation"></span><h3>Adapted APIs<a class="headerlink" href="#adapted-apis" title="Permalink to this heading"></a></h3>
<blockquote>
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When using any lwIP API other than the <a class="reference internal" href="#bsd-sockets-api">BSD Sockets API</a>, please make sure that the API is thread-safe. To check if a given API call is thread-safe, enable the <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-check-thread-safety"><span class="std std-ref">CONFIG_LWIP_CHECK_THREAD_SAFETY</span></a> configuration option and run the application. This enables lwIP to assert the correct access of the TCP/IP core functionality. If the API is not accessed or locked properly from the appropriate <a class="reference internal" href="#lwip-freertos-task">lwIP FreeRTOS Task</a>, the execution will be aborted. The general recommendation is to use the <a class="reference internal" href="../api-reference/network/esp_netif.html"><span class="doc">ESP-NETIF</span></a> component to interact with lwIP.</p>
</div>
</div></blockquote>
<p>Some common lwIP app APIs are supported indirectly by ESP-IDF:</p>
<ul class="simple">
<li><p>Dynamic Host Configuration Protocol (DHCP) Server &amp; Client are supported indirectly via the <a class="reference internal" href="../api-reference/network/esp_netif.html"><span class="doc">ESP-NETIF</span></a> functionality.</p></li>
<li><p>Domain Name System (DNS) is supported in lwIP; DNS servers could be assigned automatically when acquiring a DHCP address, or manually configured using the <a class="reference internal" href="../api-reference/network/esp_netif.html"><span class="doc">ESP-NETIF</span></a> API.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>DNS server configuration in lwIP is global, not interface-specific. If you are using multiple network interfaces with distinct DNS servers, exercise caution to prevent inadvertent overwrites of one interface's DNS settings when acquiring a DHCP lease from another interface.</p>
</div>
<ul class="simple">
<li><p>Simple Network Time Protocol (SNTP) is also supported via the <a class="reference internal" href="../api-reference/network/esp_netif.html"><span class="doc">ESP-NETIF</span></a>, or directly via the <a class="reference external" href="https://github.com/espressif/esp-idf/blob/v5.4.2/components/lwip/include/apps/esp_sntp.h">lwip/include/apps/esp_sntp.h</a> functions, which also provide thread-safe API to <a class="reference external" href="https://github.com/espressif/esp-lwip/blob/fa4dffd/src/include/lwip/apps/sntp.h">lwip/lwip/src/include/lwip/apps/sntp.h</a> functions, see also <a class="reference internal" href="../api-reference/system/system_time.html#system-time-sntp-sync"><span class="std std-ref">SNTP Time Synchronization</span></a>. For implementation details, see <a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/protocols/sntp">protocols/sntp</a>. This example demonstrates how to use the LwIP SNTP module to obtain time from internet servers, configure the synchronization method and interval, and retrieve time using the SNTP-over-DHCP module.</p></li>
<li><p>ICMP Ping is supported using a variation on the lwIP ping API, see <a class="reference internal" href="../api-reference/protocols/icmp_echo.html"><span class="doc">ICMP Echo</span></a>.</p></li>
<li><p>ICMPv6 Ping, supported by lwIP's ICMPv6 Echo API, is used to test IPv6 network connectivity. For more information, see <a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/protocols/sockets/icmpv6_ping">protocols/sockets/icmpv6_ping</a>. This example demonstrates how to use the network interface to discover an IPv6 address, create a raw ICMPv6 socket, send an ICMPv6 Echo Request to a destination IPv6 address, and wait for an Echo Reply from the target.</p></li>
<li><p>NetBIOS lookup is available using the standard lwIP API. <a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/protocols/http_server/restful_server">protocols/http_server/restful_server</a> has the option to demonstrate using NetBIOS to look up a host on the LAN.</p></li>
<li><p>mDNS uses a different implementation to the lwIP default mDNS, see <a class="reference internal" href="../api-reference/protocols/mdns.html"><span class="doc">mDNS Service</span></a>. But lwIP can look up mDNS hosts using standard APIs such as <code class="docutils literal notranslate"><span class="pre">gethostbyname()</span></code> and the convention <code class="docutils literal notranslate"><span class="pre">hostname.local</span></code>, provided the <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-dns-support-mdns-queries"><span class="std std-ref">CONFIG_LWIP_DNS_SUPPORT_MDNS_QUERIES</span></a> setting is enabled.</p></li>
<li><p>The PPP implementation in lwIP can be used to create PPPoS (PPP over serial) interface in ESP-IDF. Please refer to the documentation of the <a class="reference internal" href="../api-reference/network/esp_netif.html"><span class="doc">ESP-NETIF</span></a> component to create and configure a PPP network interface, by means of the <code class="docutils literal notranslate"><span class="pre">ESP_NETIF_DEFAULT_PPP()</span></code> macro defined in <a class="reference external" href="https://github.com/espressif/esp-idf/blob/v5.4.2/components/esp_netif/include/esp_netif_defaults.h">esp_netif/include/esp_netif_defaults.h</a>. Additional runtime settings are provided via <a class="reference external" href="https://github.com/espressif/esp-idf/blob/v5.4.2/components/esp_netif/include/esp_netif_ppp.h">esp_netif/include/esp_netif_ppp.h</a>. PPPoS interfaces are typically used to interact with NBIoT/GSM/LTE modems. More application-level friendly API is supported by the <a class="reference external" href="https://components.espressif.com/component/espressif/esp_modem">esp_modem</a> library, which uses this PPP lwIP module behind the scenes.</p></li>
</ul>
</section>
</section>
<section id="bsd-sockets-api">
<h2>BSD Sockets API<a class="headerlink" href="#bsd-sockets-api" title="Permalink to this heading"></a></h2>
<p>The BSD Sockets API is a common cross-platform TCP/IP sockets API that originated in the Berkeley Standard Distribution of UNIX but is now standardized in a section of the POSIX specification. BSD Sockets are sometimes called POSIX Sockets or Berkeley Sockets.</p>
<p>As implemented in ESP-IDF, lwIP supports all of the common usages of the BSD Sockets API.</p>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Permalink to this heading"></a></h3>
<p>A wide range of BSD Sockets reference materials are available, including:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://pubs.opengroup.org/onlinepubs/007908799/xnsix.html">Single UNIX Specification - BSD Sockets page</a></p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Berkeley_sockets">Berkeley Sockets - Wikipedia page</a></p></li>
</ul>
</section>
<section id="application-examples">
<h3>Application Examples<a class="headerlink" href="#application-examples" title="Permalink to this heading"></a></h3>
<p>A number of ESP-IDF examples show how to use the BSD Sockets APIs:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/protocols/sockets/non_blocking">protocols/sockets/non_blocking</a> demonstrates how to configure and run a non-blocking TCP client and server, supporting both IPv4 and IPv6 protocols.</p></li>
<li><p><a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/protocols/sockets/tcp_server">protocols/sockets/tcp_server</a> demonstrates how to create a TCP server that accepts client connection requests and receives data.</p></li>
<li><p><a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/protocols/sockets/tcp_client">protocols/sockets/tcp_client</a> demonstrates how to create a TCP client that connects to a server using a predefined IP address and port.</p></li>
<li><p><a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/protocols/sockets/tcp_client_multi_net">protocols/sockets/tcp_client_multi_net</a> demonstrates how to use Ethernet and Wi-Fi interfaces together, connect to both simultaneously, create a TCP client for each interface, and send a basic HTTP request and response.</p></li>
<li><p><a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/protocols/sockets/udp_server">protocols/sockets/udp_server</a> demonstrates how to create a UDP server that receives client connection requests and data.</p></li>
<li><p><a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/protocols/sockets/udp_client">protocols/sockets/udp_client</a> demonstrates how to create a UDP client that connects to a server using a predefined IP address and port.</p></li>
<li><p><a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/protocols/sockets/udp_multicast">protocols/sockets/udp_multicast</a> demonstrates how to use the IPV4 and IPV6 UDP multicast features via the BSD-style sockets interface.</p></li>
</ul>
</section>
<section id="supported-functions">
<h3>Supported Functions<a class="headerlink" href="#supported-functions" title="Permalink to this heading"></a></h3>
<p>The following BSD socket API functions are supported. For full details, see <a class="reference external" href="https://github.com/espressif/esp-lwip/blob/fa4dffd/src/include/lwip/sockets.h">lwip/lwip/src/include/lwip/sockets.h</a>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">socket()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bind()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accept()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shutdown()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">getpeername()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">getsockopt()</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">setsockopt()</span></code>: see <a class="reference internal" href="#socket-options">Socket Options</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">close()</span></code>: via <a class="reference internal" href="../api-reference/storage/vfs.html"><span class="doc">Virtual Filesystem Component</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">read()</span></code>, <code class="docutils literal notranslate"><span class="pre">readv()</span></code>, <code class="docutils literal notranslate"><span class="pre">write()</span></code>, <code class="docutils literal notranslate"><span class="pre">writev()</span></code>: via <a class="reference internal" href="../api-reference/storage/vfs.html"><span class="doc">Virtual Filesystem Component</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">recv()</span></code>, <code class="docutils literal notranslate"><span class="pre">recvmsg()</span></code>, <code class="docutils literal notranslate"><span class="pre">recvfrom()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">send()</span></code>, <code class="docutils literal notranslate"><span class="pre">sendmsg()</span></code>, <code class="docutils literal notranslate"><span class="pre">sendto()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">select()</span></code>: via <a class="reference internal" href="../api-reference/storage/vfs.html"><span class="doc">Virtual Filesystem Component</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">poll()</span></code> : on ESP-IDF, <code class="docutils literal notranslate"><span class="pre">poll()</span></code> is implemented by calling <code class="docutils literal notranslate"><span class="pre">select()</span></code> internally, so using <code class="docutils literal notranslate"><span class="pre">select()</span></code> directly is recommended, if a choice of methods is available</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fcntl()</span></code>: see <a class="reference internal" href="#fcntl">fcntl()</a></p></li>
</ul>
<p>Non-standard functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ioctl()</span></code>: see <a class="reference internal" href="#ioctl">ioctl()</a></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some lwIP application sample code uses prefixed versions of BSD APIs, e.g., <code class="docutils literal notranslate"><span class="pre">lwip_socket()</span></code>, instead of the standard <code class="docutils literal notranslate"><span class="pre">socket()</span></code>. Both forms can be used with ESP-IDF, but using standard names is recommended.</p>
</div>
</section>
<section id="socket-error-handling">
<h3>Socket Error Handling<a class="headerlink" href="#socket-error-handling" title="Permalink to this heading"></a></h3>
<p>BSD Socket error handling code is very important for robust socket applications. Normally, socket error handling involves the following aspects:</p>
<ul class="simple">
<li><p>Detecting the error</p></li>
<li><p>Getting the error reason code</p></li>
<li><p>Handling the error according to the reason code</p></li>
</ul>
<p>In lwIP, we have two different scenarios for handling socket errors:</p>
<ul class="simple">
<li><p>Socket API returns an error. For more information, see <a class="reference internal" href="#socket-api-errors">Socket API Errors</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">select(int</span> <span class="pre">maxfdp1,</span> <span class="pre">fd_set</span> <span class="pre">*readset,</span> <span class="pre">fd_set</span> <span class="pre">*writeset,</span> <span class="pre">fd_set</span> <span class="pre">*exceptset,</span> <span class="pre">struct</span> <span class="pre">timeval</span> <span class="pre">*timeout)</span></code> has an exception descriptor indicating that the socket has an error. For more information, see <a class="reference internal" href="#select-errors">select() Errors</a>.</p></li>
</ul>
<section id="socket-api-errors">
<h4>Socket API Errors<a class="headerlink" href="#socket-api-errors" title="Permalink to this heading"></a></h4>
<p><strong>Error detection</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>We can know that the socket API fails according to its return value.</p></li>
</ul>
</div></blockquote>
<p><strong>Get the error reason code</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>When socket API fails, the return value does not contain the failure reason and the application can get the error reason code by accessing <code class="docutils literal notranslate"><span class="pre">errno</span></code>. Different values indicate different meanings. For more information, see <a class="reference internal" href="#socket-error-reason-code">Socket Error Reason Code</a>.</p></li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">err</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">sockfd</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">SOCK_STREAM</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">the</span> <span class="n">error</span> <span class="n">code</span> <span class="ow">is</span> <span class="n">obtained</span> <span class="kn">from</span> <span class="nn">errno</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="select-errors">
<h4><code class="docutils literal notranslate"><span class="pre">select()</span></code> Errors<a class="headerlink" href="#select-errors" title="Permalink to this heading"></a></h4>
<p><strong>Error detection</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>Socket error when <code class="docutils literal notranslate"><span class="pre">select()</span></code> has exception descriptor.</p></li>
</ul>
</div></blockquote>
<p><strong>Get the error reason code</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>If the <code class="docutils literal notranslate"><span class="pre">select()</span></code> indicates that the socket fails, we can not get the error reason code by accessing <code class="docutils literal notranslate"><span class="pre">errno</span></code>, instead we should call <code class="docutils literal notranslate"><span class="pre">getsockopt()</span></code> to get the failure reason code. Since <code class="docutils literal notranslate"><span class="pre">select()</span></code> has exception descriptor, the error code is not given to <code class="docutils literal notranslate"><span class="pre">errno</span></code>.</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">getsockopt()</span></code> function has the following prototype: <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">getsockopt(int</span> <span class="pre">s,</span> <span class="pre">int</span> <span class="pre">level,</span> <span class="pre">int</span> <span class="pre">optname,</span> <span class="pre">void</span> <span class="pre">*optval,</span> <span class="pre">socklen_t</span> <span class="pre">*optlen)</span></code>. Its purpose is to get the current value of the option of any type, any state socket, and store the result in <code class="docutils literal notranslate"><span class="pre">optval</span></code>. For example, when you get the error code on a socket, you can get it by <code class="docutils literal notranslate"><span class="pre">getsockopt(sockfd,</span> <span class="pre">SOL_SOCKET,</span> <span class="pre">SO_ERROR,</span> <span class="pre">&amp;err,</span> <span class="pre">&amp;optlen)</span></code>.</p>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">err</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">sockfd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exfds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tval</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exfds</span><span class="p">))</span> <span class="p">{</span>
        <span class="o">//</span> <span class="n">select</span><span class="p">()</span> <span class="n">exception</span> <span class="nb">set</span> <span class="n">using</span> <span class="n">getsockopt</span><span class="p">()</span>
        <span class="nb">int</span> <span class="n">optlen</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="nb">int</span><span class="p">);</span>
        <span class="n">getsockopt</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">optlen</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="socket-error-reason-code">
<h4>Socket Error Reason Code<a class="headerlink" href="#socket-error-reason-code" title="Permalink to this heading"></a></h4>
<p>Below is a list of common error codes. For a more detailed list of standard POSIX/C error codes, please see <a class="reference external" href="https://github.com/espressif/newlib-esp32/blob/master/newlib/libc/include/sys/errno.h">newlib errno.h</a> and the platform-specific extensions <a class="reference external" href="https://github.com/espressif/esp-idf/blob/v5.4.2/components/newlib/platform_include/errno.h">newlib/platform_include/errno.h</a>.</p>
<table class="docutils align-center">
<colgroup>
<col style="width: 50.0%" />
<col style="width: 50.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Error code</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ECONNREFUSED</p></td>
<td><p>Connection refused</p></td>
</tr>
<tr class="row-odd"><td><p>EADDRINUSE</p></td>
<td><p>Address already in use</p></td>
</tr>
<tr class="row-even"><td><p>ECONNABORTED</p></td>
<td><p>Software caused connection abort</p></td>
</tr>
<tr class="row-odd"><td><p>ENETUNREACH</p></td>
<td><p>Network is unreachable</p></td>
</tr>
<tr class="row-even"><td><p>ENETDOWN</p></td>
<td><p>Network interface is not configured</p></td>
</tr>
<tr class="row-odd"><td><p>ETIMEDOUT</p></td>
<td><p>Connection timed out</p></td>
</tr>
<tr class="row-even"><td><p>EHOSTDOWN</p></td>
<td><p>Host is down</p></td>
</tr>
<tr class="row-odd"><td><p>EHOSTUNREACH</p></td>
<td><p>Host is unreachable</p></td>
</tr>
<tr class="row-even"><td><p>EINPROGRESS</p></td>
<td><p>Connection already in progress</p></td>
</tr>
<tr class="row-odd"><td><p>EALREADY</p></td>
<td><p>Socket already connected</p></td>
</tr>
<tr class="row-even"><td><p>EDESTADDRREQ</p></td>
<td><p>Destination address required</p></td>
</tr>
<tr class="row-odd"><td><p>EPROTONOSUPPORT</p></td>
<td><p>Unknown protocol</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="socket-options">
<h3>Socket Options<a class="headerlink" href="#socket-options" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">getsockopt()</span></code> and <code class="docutils literal notranslate"><span class="pre">setsockopt()</span></code> functions allow getting and setting per-socket options respectively.</p>
<p>Not all standard socket options are supported by lwIP in ESP-IDF. The following socket options are supported:</p>
<section id="common-options">
<h4>Common Options<a class="headerlink" href="#common-options" title="Permalink to this heading"></a></h4>
<p>Used with level argument <code class="docutils literal notranslate"><span class="pre">SOL_SOCKET</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SO_REUSEADDR</span></code>: available if <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-so-reuse"><span class="std std-ref">CONFIG_LWIP_SO_REUSE</span></a> is set, whose behavior can be customized by setting <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-so-reuse-rxtoall"><span class="std std-ref">CONFIG_LWIP_SO_REUSE_RXTOALL</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SO_KEEPALIVE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SO_BROADCAST</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SO_ACCEPTCONN</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SO_RCVBUF</span></code>: available if <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-so-rcvbuf"><span class="std std-ref">CONFIG_LWIP_SO_RCVBUF</span></a> is set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SO_SNDTIMEO</span></code> / <code class="docutils literal notranslate"><span class="pre">SO_RCVTIMEO</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SO_ERROR</span></code>: only used with <code class="docutils literal notranslate"><span class="pre">select()</span></code>, see <a class="reference internal" href="#socket-error-handling">Socket Error Handling</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SO_TYPE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SO_NO_CHECK</span></code>: for UDP sockets only</p></li>
</ul>
</section>
<section id="ip-options">
<h4>IP Options<a class="headerlink" href="#ip-options" title="Permalink to this heading"></a></h4>
<p>Used with level argument <code class="docutils literal notranslate"><span class="pre">IPPROTO_IP</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IP_TOS</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IP_TTL</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IP_PKTINFO</span></code>: available if <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-netbuf-recvinfo"><span class="std std-ref">CONFIG_LWIP_NETBUF_RECVINFO</span></a> is set</p></li>
</ul>
<p>For multicast UDP sockets:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IP_MULTICAST_IF</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IP_MULTICAST_LOOP</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IP_MULTICAST_TTL</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IP_ADD_MEMBERSHIP</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IP_DROP_MEMBERSHIP</span></code></p></li>
</ul>
</section>
<section id="tcp-options">
<h4>TCP Options<a class="headerlink" href="#tcp-options" title="Permalink to this heading"></a></h4>
<p>TCP sockets only. Used with level argument <code class="docutils literal notranslate"><span class="pre">IPPROTO_TCP</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TCP_NODELAY</span></code></p></li>
</ul>
<p>Options relating to TCP keepalive probes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TCP_KEEPALIVE</span></code>: int value, TCP keepalive period in milliseconds</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TCP_KEEPIDLE</span></code>: same as <code class="docutils literal notranslate"><span class="pre">TCP_KEEPALIVE</span></code>, but the value is in seconds</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TCP_KEEPINTVL</span></code>: int value, the interval between keepalive probes in seconds</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TCP_KEEPCNT</span></code>: int value, number of keepalive probes before timing out</p></li>
</ul>
</section>
<section id="ipv6-options">
<h4>IPv6 Options<a class="headerlink" href="#ipv6-options" title="Permalink to this heading"></a></h4>
<p>IPv6 sockets only. Used with level argument <code class="docutils literal notranslate"><span class="pre">IPPROTO_IPV6</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IPV6_CHECKSUM</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IPV6_V6ONLY</span></code></p></li>
</ul>
<p>For multicast IPv6 UDP sockets:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IPV6_JOIN_GROUP</span></code> / <code class="docutils literal notranslate"><span class="pre">IPV6_ADD_MEMBERSHIP</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IPV6_LEAVE_GROUP</span></code> / <code class="docutils literal notranslate"><span class="pre">IPV6_DROP_MEMBERSHIP</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IPV6_MULTICAST_IF</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IPV6_MULTICAST_HOPS</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IPV6_MULTICAST_LOOP</span></code></p></li>
</ul>
</section>
</section>
<section id="fcntl">
<h3><code class="docutils literal notranslate"><span class="pre">fcntl()</span></code><a class="headerlink" href="#fcntl" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">fcntl()</span></code> function is a standard API for manipulating options related to a file descriptor. In ESP-IDF, the <a class="reference internal" href="../api-reference/storage/vfs.html"><span class="doc">Virtual Filesystem Component</span></a> layer is used to implement this function.</p>
<p>When the file descriptor is a socket, only the following <code class="docutils literal notranslate"><span class="pre">fcntl()</span></code> values are supported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">O_NONBLOCK</span></code> to set or clear non-blocking I/O mode. Also supports <code class="docutils literal notranslate"><span class="pre">O_NDELAY</span></code>, which is identical to <code class="docutils literal notranslate"><span class="pre">O_NONBLOCK</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">O_RDONLY</span></code>, <code class="docutils literal notranslate"><span class="pre">O_WRONLY</span></code>, <code class="docutils literal notranslate"><span class="pre">O_RDWR</span></code> flags for different read or write modes. These flags can only be read using <code class="docutils literal notranslate"><span class="pre">F_GETFL</span></code>, and cannot be set using <code class="docutils literal notranslate"><span class="pre">F_SETFL</span></code>. A TCP socket returns a different mode depending on whether the connection has been closed at either end or is still open at both ends. UDP sockets always return <code class="docutils literal notranslate"><span class="pre">O_RDWR</span></code>.</p></li>
</ul>
</section>
<section id="ioctl">
<h3><code class="docutils literal notranslate"><span class="pre">ioctl()</span></code><a class="headerlink" href="#ioctl" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">ioctl()</span></code> function provides a semi-standard way to access some internal features of the TCP/IP stack. In ESP-IDF, the <a class="reference internal" href="../api-reference/storage/vfs.html"><span class="doc">Virtual Filesystem Component</span></a> layer is used to implement this function.</p>
<p>When the file descriptor is a socket, only the following <code class="docutils literal notranslate"><span class="pre">ioctl()</span></code> values are supported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FIONREAD</span></code> returns the number of bytes of the pending data already received in the socket's network buffer.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FIONBIO</span></code> is an alternative way to set/clear non-blocking I/O status for a socket, equivalent to <code class="docutils literal notranslate"><span class="pre">fcntl(fd,</span> <span class="pre">F_SETFL,</span> <span class="pre">O_NONBLOCK,</span> <span class="pre">...)</span></code>.</p></li>
</ul>
</section>
</section>
<section id="netconn-api">
<h2>Netconn API<a class="headerlink" href="#netconn-api" title="Permalink to this heading"></a></h2>
<p>lwIP supports two lower-level APIs as well as the BSD Sockets API: the Netconn API and the Raw API.</p>
<p>The lwIP Raw API is designed for single-threaded devices and is not supported in ESP-IDF.</p>
<p>The Netconn API is used to implement the BSD Sockets API inside lwIP, and it can also be called directly from ESP-IDF apps. This API has lower resource usage than the BSD Sockets API. In particular, it can send and receive data without firstly copying it into internal lwIP buffers.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Espressif does not test the Netconn API in ESP-IDF. As such, this functionality is <strong>enabled but not supported</strong>. Some functionality may only work correctly when used from the BSD Sockets API.</p>
</div>
<p>For more information about the Netconn API, consult <a class="reference external" href="http://www.nongnu.org/lwip/2_0_x/api_8h.html">lwip/lwip/src/include/lwip/api.h</a> and <a class="reference external" href="https://lwip.fandom.com/wiki/Netconn_API">part of the **unofficial** lwIP Application Developers Manual</a>.</p>
</section>
<section id="lwip-freertos-task">
<h2>lwIP FreeRTOS Task<a class="headerlink" href="#lwip-freertos-task" title="Permalink to this heading"></a></h2>
<p>lwIP creates a dedicated TCP/IP FreeRTOS task to handle socket API requests from other tasks.</p>
<p>A number of configuration items are available to modify the task and the queues (mailboxes) used to send data to/from the TCP/IP task:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-lwip-tcpip-recvmbox-size"><span class="std std-ref">CONFIG_LWIP_TCPIP_RECVMBOX_SIZE</span></a></p></li>
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-lwip-tcpip-task-stack-size"><span class="std std-ref">CONFIG_LWIP_TCPIP_TASK_STACK_SIZE</span></a></p></li>
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-lwip-tcpip-task-affinity"><span class="std std-ref">CONFIG_LWIP_TCPIP_TASK_AFFINITY</span></a></p></li>
</ul>
</section>
<section id="ipv6-support">
<h2>IPv6 Support<a class="headerlink" href="#ipv6-support" title="Permalink to this heading"></a></h2>
<p>Both IPv4 and IPv6 are supported in a dual-stack configuration and are enabled by default. Both IPv6 and IPv4 may be disabled separately if they are not needed, see <a class="reference internal" href="#lwip-ram-usage"><span class="std std-ref">Minimum RAM Usage</span></a>.</p>
<p>IPv6 support is limited to <strong>Stateless Autoconfiguration</strong> only. <strong>Stateful configuration</strong> is not supported in ESP-IDF, nor in upstream lwIP.</p>
<p>IPv6 Address configuration is defined by means of these protocols or services:</p>
<ul class="simple">
<li><p><strong>SLAAC</strong> IPv6 Stateless Address Autoconfiguration (RFC-2462)</p></li>
<li><p><strong>DHCPv6</strong> Dynamic Host Configuration Protocol for IPv6 (RFC-8415)</p></li>
</ul>
<p>None of these two types of address configuration is enabled by default, so the device uses only Link Local addresses or statically-defined addresses.</p>
<section id="stateless-autoconfiguration-process">
<span id="lwip-ivp6-autoconfig"></span><h3>Stateless Autoconfiguration Process<a class="headerlink" href="#stateless-autoconfiguration-process" title="Permalink to this heading"></a></h3>
<p>To enable address autoconfiguration using the Router Advertisement protocol, please enable:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-lwip-ipv6-autoconfig"><span class="std std-ref">CONFIG_LWIP_IPV6_AUTOCONFIG</span></a></p></li>
</ul>
<p>This configuration option enables IPv6 autoconfiguration for all network interfaces, which differs from the upstream lwIP behavior, where the autoconfiguration needs to be explicitly enabled for each <code class="docutils literal notranslate"><span class="pre">netif</span></code> with <code class="docutils literal notranslate"><span class="pre">netif-&gt;ip6_autoconfig_enabled=1</span></code>.</p>
</section>
<section id="dhcpv6">
<span id="lwip-ivp6-dhcp6"></span><h3>DHCPv6<a class="headerlink" href="#dhcpv6" title="Permalink to this heading"></a></h3>
<p>DHCPv6 in lwIP is very simple and supports only stateless configuration. It could be enabled using:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-lwip-ipv6-dhcp6"><span class="std std-ref">CONFIG_LWIP_IPV6_DHCP6</span></a></p></li>
</ul>
<p>Since the DHCPv6 works only in its stateless configuration, the <a class="reference internal" href="#lwip-ivp6-autoconfig"><span class="std std-ref">Stateless Autoconfiguration Process</span></a> has to be enabled as well via <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-ipv6-autoconfig"><span class="std std-ref">CONFIG_LWIP_IPV6_AUTOCONFIG</span></a>.</p>
<p>Moreover, the DHCPv6 needs to be explicitly enabled from the application code using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dhcp6_enable_stateless</span><span class="p">(</span><span class="n">netif</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="dns-servers-in-ipv6-autoconfiguration">
<h3>DNS Servers in IPv6 Autoconfiguration<a class="headerlink" href="#dns-servers-in-ipv6-autoconfiguration" title="Permalink to this heading"></a></h3>
<p>In order to autoconfigure DNS server(s), especially in IPv6-only networks, we have these two options:</p>
<ul>
<li><p>Recursive Domain Name System (DNS): this belongs to the Neighbor Discovery Protocol (NDP) and uses <a class="reference internal" href="#lwip-ivp6-autoconfig"><span class="std std-ref">Stateless Autoconfiguration Process</span></a>.</p>
<p>The number of servers must be set <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-ipv6-rdnss-max-dns-servers"><span class="std std-ref">CONFIG_LWIP_IPV6_RDNSS_MAX_DNS_SERVERS</span></a>, this option is disabled by default, i.e., set to 0.</p>
</li>
<li><p>DHCPv6 stateless configuration, uses <a class="reference internal" href="#lwip-ivp6-dhcp6"><span class="std std-ref">DHCPv6</span></a> to configure DNS servers. Note that this configuration assumes IPv6 Router Advertisement Flags (RFC-5175) to be set to</p>
<blockquote>
<div><ul class="simple">
<li><p>Managed Address Configuration Flag = 0</p></li>
<li><p>Other Configuration Flag = 1</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</section>
</section>
<section id="esp-lwip-custom-modifications">
<h2>ESP-lwIP Custom Modifications<a class="headerlink" href="#esp-lwip-custom-modifications" title="Permalink to this heading"></a></h2>
<section id="additions">
<h3>Additions<a class="headerlink" href="#additions" title="Permalink to this heading"></a></h3>
<p>The following code is added, which is not present in the upstream lwIP release:</p>
<section id="thread-safe-sockets">
<h4>Thread-Safe Sockets<a class="headerlink" href="#thread-safe-sockets" title="Permalink to this heading"></a></h4>
<p>It is possible to <code class="docutils literal notranslate"><span class="pre">close()</span></code> a socket from a different thread than the one that created it. The <code class="docutils literal notranslate"><span class="pre">close()</span></code> call blocks, until any function calls currently using that socket from other tasks have returned.</p>
<p>It is, however, not possible to delete a task while it is actively waiting on <code class="docutils literal notranslate"><span class="pre">select()</span></code> or <code class="docutils literal notranslate"><span class="pre">poll()</span></code> APIs. It is always necessary that these APIs exit before destroying the task, as this might corrupt internal structures and cause subsequent crashes of the lwIP. These APIs allocate globally referenced callback pointers on the stack so that when the task gets destroyed before unrolling the stack, the lwIP could still hold pointers to the deleted stack.</p>
</section>
<section id="on-demand-timers">
<h4>On-Demand Timers<a class="headerlink" href="#on-demand-timers" title="Permalink to this heading"></a></h4>
<p>lwIP IGMP and MLD6 feature both initialize a timer in order to trigger timeout events at certain times.</p>
<p>The default lwIP implementation is to have these timers enabled all the time, even if no timeout events are active. This increases CPU usage and power consumption when using automatic Light-sleep mode. <code class="docutils literal notranslate"><span class="pre">ESP-lwIP</span></code> default behavior is to set each timer <code class="docutils literal notranslate"><span class="pre">on</span> <span class="pre">demand</span></code>, so it is only enabled when an event is pending.</p>
<p>To return to the default lwIP behavior, which is always-on timers, disable <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-timers-ondemand"><span class="std std-ref">CONFIG_LWIP_TIMERS_ONDEMAND</span></a>.</p>
</section>
<section id="lwip-timers-api">
<h4>lwIP Timers API<a class="headerlink" href="#lwip-timers-api" title="Permalink to this heading"></a></h4>
<p>When not using Wi-Fi, the lwIP timer can be turned off via the API to reduce power consumption.</p>
<p>The following API functions are supported. For full details, see <a class="reference external" href="https://github.com/espressif/esp-lwip/blob/fa4dffd/src/include/lwip/timeouts.h">lwip/lwip/src/include/lwip/timeouts.h</a>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sys_timeouts_init()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sys_timeouts_deinit()</span></code></p></li>
</ul>
</section>
<section id="additional-socket-options">
<h4>Additional Socket Options<a class="headerlink" href="#additional-socket-options" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>Some standard IPV4 and IPV6 multicast socket options are implemented, see <a class="reference internal" href="#socket-options">Socket Options</a>.</p></li>
<li><p>Possible to set IPV6-only UDP and TCP sockets with <code class="docutils literal notranslate"><span class="pre">IPV6_V6ONLY</span></code> socket option, while normal lwIP is TCP-only.</p></li>
</ul>
</section>
<section id="ip-layer-features">
<h4>IP Layer Features<a class="headerlink" href="#ip-layer-features" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>IPV4-source-based routing implementation is different</p></li>
<li><p>IPV4-mapped IPV6 addresses are supported</p></li>
</ul>
</section>
<section id="napt-and-port-forwarding">
<h4>NAPT and Port Forwarding<a class="headerlink" href="#napt-and-port-forwarding" title="Permalink to this heading"></a></h4>
<p>IPV4 network address port translation (NAPT) and port forwarding are supported. However, the enabling of NAPT is limited to a single interface.</p>
<ul class="simple">
<li><p>To use NAPT for forwarding packets between two interfaces, it needs to be enabled on the interface connecting to the target network. For example, to enable internet access for Ethernet traffic through the Wi-Fi interface, NAPT must be enabled on the Ethernet interface.</p></li>
<li><p>Usage of NAPT is demonstrated in <a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/network/vlan_support">network/vlan_support</a>.</p></li>
</ul>
</section>
<section id="customized-lwip-hooks">
<span id="lwip-custom-hooks"></span><h4>Customized lwIP Hooks<a class="headerlink" href="#customized-lwip-hooks" title="Permalink to this heading"></a></h4>
<p>The original lwIP supports implementing custom compile-time modifications via <code class="docutils literal notranslate"><span class="pre">LWIP_HOOK_FILENAME</span></code>. This file is already used by the ESP-IDF port layer, but ESP-IDF users could still include and implement any custom additions via a header file defined by the macro <code class="docutils literal notranslate"><span class="pre">ESP_IDF_LWIP_HOOK_FILENAME</span></code>. Here is an example of adding a custom hook file to the build process, and the hook is called <code class="docutils literal notranslate"><span class="pre">my_hook.h</span></code>, located in the project's <code class="docutils literal notranslate"><span class="pre">main</span></code> folder:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_get_property</span><span class="p">(</span><span class="s">lwip</span><span class="w"> </span><span class="s">lwip</span><span class="w"> </span><span class="s">COMPONENT_LIB</span><span class="p">)</span>
<span class="nb">target_compile_options</span><span class="p">(</span><span class="o">${</span><span class="nv">lwip</span><span class="o">}</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s2">&quot;-I${PROJECT_DIR}/main&quot;</span><span class="p">)</span>
<span class="nb">target_compile_definitions</span><span class="p">(</span><span class="o">${</span><span class="nv">lwip</span><span class="o">}</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s2">&quot;-DESP_IDF_LWIP_HOOK_FILENAME=\&quot;</span><span class="s">my_hook.h\</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="customized-lwip-options-from-esp-idf-build-system">
<h4>Customized lwIP Options From ESP-IDF Build System<a class="headerlink" href="#customized-lwip-options-from-esp-idf-build-system" title="Permalink to this heading"></a></h4>
<p>The most common lwIP options are configurable through the component configuration menu. However, certain definitions need to be injected from the command line. The CMake function <code class="docutils literal notranslate"><span class="pre">target_compile_definitions()</span></code> can be employed to define macros, as illustrated below:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">idf_component_get_property</span><span class="p">(</span><span class="s">lwip</span><span class="w"> </span><span class="s">lwip</span><span class="w"> </span><span class="s">COMPONENT_LIB</span><span class="p">)</span>
<span class="nb">target_compile_definitions</span><span class="p">(</span><span class="o">${</span><span class="nv">lwip</span><span class="o">}</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s2">&quot;-DETHARP_SUPPORT_VLAN=1&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This approach may not work for function-like macros, as there is no guarantee that the definition will be accepted by all compilers, although it is supported in GCC. To address this limitation, the <code class="docutils literal notranslate"><span class="pre">add_definitions()</span></code> function can be utilized to define the macro for the entire project, for example: <code class="docutils literal notranslate"><span class="pre">add_definitions(&quot;-DFALLBACK_DNS_SERVER_ADDRESS(addr)=\&quot;IP_ADDR4((addr),</span> <span class="pre">8,8,8,8)\&quot;&quot;)</span></code>.</p>
<p>Alternatively, you can define your function-like macro in a header file which will be pre-included as an lwIP hook file, see <a class="reference internal" href="#lwip-custom-hooks"><span class="std std-ref">Customized lwIP Hooks</span></a>.</p>
</section>
</section>
<section id="limitations">
<h3>Limitations<a class="headerlink" href="#limitations" title="Permalink to this heading"></a></h3>
<p>ESP-IDF additions to lwIP still suffer from the global DNS limitation, described in <a class="reference internal" href="#lwip-dns-limitation"><span class="std std-ref">Adapted APIs</span></a>. To address this limitation from application code, the <code class="docutils literal notranslate"><span class="pre">FALLBACK_DNS_SERVER_ADDRESS()</span></code> macro can be utilized to define a global DNS fallback server accessible from all interfaces. Alternatively, you have the option to maintain per-interface DNS servers and reconfigure them whenever the default interface changes.</p>
<p>The number of IP addresses returned by network database APIs such as <code class="docutils literal notranslate"><span class="pre">getaddrinfo()</span></code> and <code class="docutils literal notranslate"><span class="pre">gethostbyname()</span></code> is restricted by the macro <code class="docutils literal notranslate"><span class="pre">DNS_MAX_HOST_IP</span></code>. By default, the value of this macro is set to 1.</p>
<p>In the implementation of <code class="docutils literal notranslate"><span class="pre">getaddrinfo()</span></code>, the canonical name is not available. Therefore, the <code class="docutils literal notranslate"><span class="pre">ai_canonname</span></code> field of the first returned <code class="docutils literal notranslate"><span class="pre">addrinfo</span></code> structure will always refer to the <code class="docutils literal notranslate"><span class="pre">nodename</span></code> argument or a string with the same contents.</p>
<p>Calling <code class="docutils literal notranslate"><span class="pre">send()</span></code> or <code class="docutils literal notranslate"><span class="pre">sendto()</span></code> repeatedly on a UDP socket may eventually fail with <code class="docutils literal notranslate"><span class="pre">errno</span></code> equal to <code class="docutils literal notranslate"><span class="pre">ENOMEM</span></code>. This failure occurs due to the limitations of buffer sizes in the lower-layer network interface drivers. If all driver transmit buffers are full, the UDP transmission will fail. For applications that transmit a high volume of UDP datagrams and aim to avoid any dropped datagrams by the sender, it is advisable to implement error code checking and employ a retransmission mechanism with a short delay.</p>
<p>Increasing the number of TX buffers in the <a class="reference internal" href="../api-reference/kconfig.html#config-esp-wifi-tx-buffer"><span class="std std-ref">Wi-Fi</span></a> or <a class="reference internal" href="../api-reference/kconfig.html#config-eth-dma-tx-buffer-num"><span class="std std-ref">Ethernet</span></a> project configuration as applicable may also help.</p>
</section>
</section>
<section id="performance-optimization">
<span id="lwip-performance"></span><h2>Performance Optimization<a class="headerlink" href="#performance-optimization" title="Permalink to this heading"></a></h2>
<p>TCP/IP performance is a complex subject, and performance can be optimized toward multiple goals. The default settings of ESP-IDF are tuned for a compromise between throughput, latency, and moderate memory usage.</p>
<section id="maximum-throughput">
<h3>Maximum Throughput<a class="headerlink" href="#maximum-throughput" title="Permalink to this heading"></a></h3>
<p>Espressif tests ESP-IDF TCP/IP throughput using the iperf test application: <a class="reference external" href="https://iperf.fr/">https://iperf.fr/</a>, please refer to <a class="reference internal" href="performance/speed.html#improve-network-speed"><span class="std std-ref">Improving Network Speed</span></a> for more details about the actual testing and using the optimized configuration.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Suggest applying changes a few at a time and checking the performance each time with a particular application workload.</p>
</div>
<ul class="simple">
<li><p>If a lot of tasks are competing for CPU time on the system, consider that the lwIP task has configurable CPU affinity (<a class="reference internal" href="../api-reference/kconfig.html#config-lwip-tcpip-task-affinity"><span class="std std-ref">CONFIG_LWIP_TCPIP_TASK_AFFINITY</span></a>) and runs at fixed priority (18, <code class="docutils literal notranslate"><span class="pre">ESP_TASK_TCPIP_PRIO</span></code>). To optimize CPU utilization, consider assigning competing tasks to different cores or adjusting their priorities to lower values. For additional details on built-in task priorities, please refer to <a class="reference internal" href="performance/speed.html#built-in-task-priorities"><span class="std std-ref">Built-in Task Priorities</span></a>.</p></li>
<li><p>If using <code class="docutils literal notranslate"><span class="pre">select()</span></code> function with socket arguments only, disabling <a class="reference internal" href="../api-reference/kconfig.html#config-vfs-support-select"><span class="std std-ref">CONFIG_VFS_SUPPORT_SELECT</span></a> will make <code class="docutils literal notranslate"><span class="pre">select()</span></code> calls faster.</p></li>
<li><p>If there is enough free IRAM, select <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-iram-optimization"><span class="std std-ref">CONFIG_LWIP_IRAM_OPTIMIZATION</span></a> and <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-extra-iram-optimization"><span class="std std-ref">CONFIG_LWIP_EXTRA_IRAM_OPTIMIZATION</span></a> to improve TX/RX throughput.</p></li>
</ul>
<p>If using a Wi-Fi network interface, please also refer to <a class="reference internal" href="wifi.html#wifi-buffer-usage"><span class="std std-ref">Wi-Fi Buffer Usage</span></a>.</p>
</section>
<section id="minimum-latency">
<h3>Minimum Latency<a class="headerlink" href="#minimum-latency" title="Permalink to this heading"></a></h3>
<p>Except for increasing buffer sizes, most changes that increase throughput also decrease latency by reducing the amount of CPU time spent in lwIP functions.</p>
<ul class="simple">
<li><p>For TCP sockets, lwIP supports setting the standard <code class="docutils literal notranslate"><span class="pre">TCP_NODELAY</span></code> flag to disable Nagle's algorithm.</p></li>
</ul>
</section>
<section id="minimum-ram-usage">
<span id="lwip-ram-usage"></span><h3>Minimum RAM Usage<a class="headerlink" href="#minimum-ram-usage" title="Permalink to this heading"></a></h3>
<p>Most lwIP RAM usage is on-demand, as RAM is allocated from the heap as needed. Therefore, changing lwIP settings to reduce RAM usage may not change RAM usage at idle, but can change it at peak.</p>
<ul class="simple">
<li><p>Reducing <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-max-sockets"><span class="std std-ref">CONFIG_LWIP_MAX_SOCKETS</span></a> reduces the maximum number of sockets in the system. This also causes TCP sockets in the <code class="docutils literal notranslate"><span class="pre">WAIT_CLOSE</span></code> state to be closed and recycled more rapidly when needed to open a new socket, further reducing peak RAM usage.</p></li>
<li><p>Reducing <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-tcpip-recvmbox-size"><span class="std std-ref">CONFIG_LWIP_TCPIP_RECVMBOX_SIZE</span></a>, <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-tcp-recvmbox-size"><span class="std std-ref">CONFIG_LWIP_TCP_RECVMBOX_SIZE</span></a> and <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-udp-recvmbox-size"><span class="std std-ref">CONFIG_LWIP_UDP_RECVMBOX_SIZE</span></a> reduce RAM usage at the expense of throughput, depending on usage.</p></li>
<li><p>Reducing <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-tcp-acceptmbox-size"><span class="std std-ref">CONFIG_LWIP_TCP_ACCEPTMBOX_SIZE</span></a> reduce RAM usage by limiting concurrent accepted connections.</p></li>
<li><p>Reducing <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-tcp-msl"><span class="std std-ref">CONFIG_LWIP_TCP_MSL</span></a> and <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-tcp-fin-wait-timeout"><span class="std std-ref">CONFIG_LWIP_TCP_FIN_WAIT_TIMEOUT</span></a> reduces the maximum segment lifetime in the system. This also causes TCP sockets in the <code class="docutils literal notranslate"><span class="pre">TIME_WAIT</span></code> and <code class="docutils literal notranslate"><span class="pre">FIN_WAIT_2</span></code> states to be closed and recycled more rapidly.</p></li>
<li><p>Disabling <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-ipv6"><span class="std std-ref">CONFIG_LWIP_IPV6</span></a> can save about 39 KB for firmware size and 2 KB RAM when the system is powered up and 7 KB RAM when the TCP/IP stack is running. If there is no requirement for supporting IPV6, it can be disabled to save flash and RAM footprint.</p></li>
<li><p>Disabling <a class="reference internal" href="../api-reference/kconfig.html#config-lwip-ipv4"><span class="std std-ref">CONFIG_LWIP_IPV4</span></a> can save about 26 KB of firmware size and 600 B RAM on power up and 6 KB RAM when the TCP/IP stack is running. If the local network supports IPv6-only configuration, IPv4 can be disabled to save flash and RAM footprint.</p></li>
</ul>
<p>If using Wi-Fi, please also refer to <a class="reference internal" href="wifi.html#wifi-buffer-usage"><span class="std std-ref">Wi-Fi Buffer Usage</span></a>.</p>
<section id="peak-buffer-usage">
<h4>Peak Buffer Usage<a class="headerlink" href="#peak-buffer-usage" title="Permalink to this heading"></a></h4>
<p>The peak heap memory that lwIP consumes is the <strong>theoretically-maximum memory</strong> that the lwIP driver consumes. Generally, the peak heap memory that lwIP consumes depends on:</p>
<blockquote>
<div><ul class="simple">
<li><p>the memory required to create a UDP connection: <code class="docutils literal notranslate"><span class="pre">lwip_udp_conn</span></code></p></li>
<li><p>the memory required to create a TCP connection: <code class="docutils literal notranslate"><span class="pre">lwip_tcp_conn</span></code></p></li>
<li><p>the number of UDP connections that the application has: <code class="docutils literal notranslate"><span class="pre">lwip_udp_con_num</span></code></p></li>
<li><p>the number of TCP connections that the application has: <code class="docutils literal notranslate"><span class="pre">lwip_tcp_con_num</span></code></p></li>
<li><p>the TCP TX window size: <code class="docutils literal notranslate"><span class="pre">lwip_tcp_tx_win_size</span></code></p></li>
<li><p>the TCP RX window size: <code class="docutils literal notranslate"><span class="pre">lwip_tcp_rx_win_size</span></code></p></li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>So, the peak heap memory that the lwIP consumes can be calculated with the following formula:</strong></dt><dd><p>lwip_dynamic_peek_memory =  (lwip_udp_con_num * lwip_udp_conn)  + (lwip_tcp_con_num * (lwip_tcp_tx_win_size + lwip_tcp_rx_win_size + lwip_tcp_conn))</p>
</dd>
</dl>
<p>Some TCP-based applications need only one TCP connection. However, they may choose to close this TCP connection and create a new one when an error occurs (e.g., a sending failure). This may result in multiple TCP connections existing in the system simultaneously, because it may take a long time for a TCP connection to close, according to the TCP state machine, refer to RFC793.</p>
</section>
</section>
</section>
</section>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

           </div>
             <div class="articleComments">

<style>
    .expand-feedback-content {
        display: none;
    }
    .click-like-or-dislike {
        background-color: #d3d3d3;
        pointer-events: none;
    }
</style>

<script>
    function submitFeedbackForm(user_likes_document) {
        // Send to GA4 the user reaction
        gtag('event', 'user_reaction', {
            'user_likes_document': user_likes_document
        });

        if (user_likes_document === 1) {
            document.querySelector('.like-btn').classList.add('click-like-or-dislike');
            document.getElementById("expandContentLike").style.display = 'block';
        } else {
            document.querySelector('.dislike-btn').classList.add('click-like-or-dislike');
            document.getElementById("expandContent").style.display = 'block';
        }

        document.querySelector('.like-btn').style.pointerEvents = 'none';
        document.querySelector('.dislike-btn').style.pointerEvents = 'none';
    }
</script>

<hr>

<p style="text-align:center"><strong>Was this page helpful?</strong></p>
<p style="text-align:center">
    <button class="like-btn" onclick="submitFeedbackForm(1)">
        <svg aria-hidden="true" focusable="false" class="color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" style="display:inline-block;user-select:none;vertical-align:text-bottom;overflow:visible">
            <path d="M8.834.066c.763.087 1.5.295 2.01.884.505.581.656 1.378.656 2.3 0 .467-.087 1.119-.157 1.637L11.328 5h1.422c.603 0 1.174.085 1.668.333.508.254.911.679 1.137 1.2.453.998.438 2.447.188 4.316l-.04.306c-.105.79-.195 1.473-.313 2.033-.131.63-.315 1.209-.668 1.672C13.97 15.847 12.706 16 11 16c-1.848 0-3.234-.333-4.388-.653-.165-.045-.323-.09-.475-.133-.658-.186-1.2-.34-1.725-.415A1.75 1.75 0 0 1 2.75 16h-1A1.75 1.75 0 0 1 0 14.25v-7.5C0 5.784.784 5 1.75 5h1a1.75 1.75 0 0 1 1.514.872c.258-.105.59-.268.918-.508C5.853 4.874 6.5 4.079 6.5 2.75v-.5c0-1.202.994-2.337 2.334-2.184ZM4.5 13.3c.705.088 1.39.284 2.072.478l.441.125c1.096.305 2.334.598 3.987.598 1.794 0 2.28-.223 2.528-.549.147-.193.276-.505.394-1.07.105-.502.188-1.124.295-1.93l.04-.3c.25-1.882.189-2.933-.068-3.497a.921.921 0 0 0-.442-.48c-.208-.104-.52-.174-.997-.174H11c-.686 0-1.295-.577-1.206-1.336.023-.192.05-.39.076-.586.065-.488.13-.97.13-1.328 0-.809-.144-1.15-.288-1.316-.137-.158-.402-.304-1.048-.378C8.357 1.521 8 1.793 8 2.25v.5c0 1.922-.978 3.128-1.933 3.825a5.831 5.831 0 0 1-1.567.81ZM2.75 6.5h-1a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h1a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
        </svg>
    </button>
    <button class="dislike-btn" onclick="submitFeedbackForm(0)">
        <svg aria-hidden="true" focusable="false" class="" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" style="display:inline-block;user-select:none;vertical-align:text-bottom;overflow:visible">
            <path d="M7.083 15.986c-.763-.087-1.499-.295-2.011-.884-.504-.581-.655-1.378-.655-2.299 0-.468.087-1.12.157-1.638l.015-.112H3.167c-.603 0-1.174-.086-1.669-.334a2.415 2.415 0 0 1-1.136-1.2c-.454-.998-.438-2.447-.188-4.316l.04-.306C.32 4.108.41 3.424.526 2.864c.132-.63.316-1.209.669-1.672C1.947.205 3.211.053 4.917.053c1.848 0 3.234.332 4.388.652l.474.133c.658.187 1.201.341 1.726.415a1.75 1.75 0 0 1 1.662-1.2h1c.966 0 1.75.784 1.75 1.75v7.5a1.75 1.75 0 0 1-1.75 1.75h-1a1.75 1.75 0 0 1-1.514-.872c-.259.105-.59.268-.919.508-.671.491-1.317 1.285-1.317 2.614v.5c0 1.201-.994 2.336-2.334 2.183Zm4.334-13.232c-.706-.089-1.39-.284-2.072-.479l-.441-.125c-1.096-.304-2.335-.597-3.987-.597-1.794 0-2.28.222-2.529.548-.147.193-.275.505-.393 1.07-.105.502-.188 1.124-.295 1.93l-.04.3c-.25 1.882-.19 2.933.067 3.497a.923.923 0 0 0 .443.48c.208.104.52.175.997.175h1.75c.685 0 1.295.577 1.205 1.335-.022.192-.049.39-.075.586-.066.488-.13.97-.13 1.329 0 .808.144 1.15.288 1.316.137.157.401.303 1.048.377.307.035.664-.237.664-.693v-.5c0-1.922.978-3.127 1.932-3.825a5.878 5.878 0 0 1 1.568-.809Zm1.75 6.798h1a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25h-1a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25Z"></path>
        </svg>
    </button>
</p>

<div class="expand-feedback-content" id="expandContentLike">
    <ul style="text-align:center">
        <li>Thank you! We received your feedback.</li>
        <li>If you have any comments, fill in <a href='https://www.espressif.com/en/company/documents/documentation_feedback?docId=4287&sections=lwIP (api-guides/lwip)&version=esp32 v5.4.2 (v5.4.2)'>Espressif Documentation Feedback Form</a>.</li>
    </ul>
</div>

<div class="expand-feedback-content" id="expandContent">
    <ul style="text-align:center">
        <li>We value your feedback.</li>
        <li>Let us know how we can improve this page by filling in <a href='https://www.espressif.com/en/company/documents/documentation_feedback?docId=4287&sections=lwIP (api-guides/lwip)&version=esp32 v5.4.2 (v5.4.2)'>Espressif Documentation Feedback Form</a>.</li>
    </ul>
</div>

<br>


             </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="low-power-mode/low-power-mode-wifi.html" class="btn btn-neutral float-left" title="Introduction to Low Power Mode in Wi-Fi Scenarios" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="memory-types.html" class="btn btn-neutral float-right" title="Memory Types" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016 - 2025, Espressif Systems (Shanghai) Co., Ltd.</p>
  </div>

  <ul class="footer">
        <li>
	    
            
            Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/espressif/sphinx_idf_theme">theme</a>  based on <a href="https://github.com/readthedocs/sphinx_rtd_theme">Read the Docs Sphinx Theme</a>.
         </li>
    <li class="footer-aside">
        <a href="../esp-idf-en-v5.4.2.zip"> Download HTML</a>
    </li>

  </ul> 

</footer>
        </div>
      </div>
    </section>
  </div>

  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>