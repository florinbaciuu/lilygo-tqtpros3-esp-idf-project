<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-73KGWFC8DM"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-73KGWFC8DM');
        </script><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manufacturing Utility - ESP32 -  &mdash; ESP-IDF Programming Guide v5.4.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=a60756f2" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=949a1ff5" />
      <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css?v=851bd809" />

  
    <link rel="canonical" href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-reference/storage/mass_mfg.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=c241bbaf"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=ff8fa330"></script>
        <script src="https://wavedrom.com/skins/default.js"></script>
        <script src="https://wavedrom.com/wavedrom.min.js"></script>
    <script src="../../_static/js/theme.js"></script>

    
        

    <script type="text/javascript">
        DOCUMENTATION_OPTIONS.PAGENAME = 'api-reference/storage/mass_mfg';
        DOCUMENTATION_OPTIONS.PROJECT_SLUG = 'esp-idf';
        DOCUMENTATION_OPTIONS.LATEST_BRANCH_NAME = 'master';
        DOCUMENTATION_OPTIONS.VERSIONS_URL = 'https://dl.espressif.com/dl/esp-idf/idf_versions.js';
        DOCUMENTATION_OPTIONS.LANGUAGES = ["en", "zh_CN"];
        DOCUMENTATION_OPTIONS.IDF_TARGET = 'esp32';
        DOCUMENTATION_OPTIONS.HAS_IDF_TARGETS = ["esp32", "esp32s2", "esp32s3", "esp32c3", "esp32c2", "esp32c5", "esp32c6", "esp32p4"]
        DOCUMENTATION_OPTIONS.RELEASE = 'v5.4.2';
        DOCUMENTATION_OPTIONS.LANGUAGE_URL = 'en';

    </script>

    <script type="text/javascript" src="https://dl.espressif.com/dl/esp-idf/idf_versions.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Non-Volatile Storage Library" href="nvs_flash.html" />
    <link rel="prev" title="Generating and Parsing FATFS on Host" href="fatfsgen.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ESP-IDF Programming Guide
              <img src="../../_static/espressif-logo.svg" class="logo" alt="Logo"/>
          </a>

          
            <div class="selectors">
              <select id="target-select" style="width: 150px;" hidden>
                <option value="" disabled selected>Choose target...</option>
              </select>
            </div>
          

          <div class="selectors">
            <select id="version-select" style="width: 150px;" hidden>
              <option value="" disabled selected>Choose version...</option>
            </select>
          </div>

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../get-started/index.html">Get Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">API Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../api-conventions.html">API Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../protocols/index.html">Application Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bluetooth/index.html">Bluetooth® API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../error-codes.html">Error Codes Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network/index.html">Networking APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../peripherals/index.html">Peripherals API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kconfig.html">Project Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../provisioning/index.html">Provisioning API</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Storage API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="fatfs.html">FAT Filesystem Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="fatfsgen.html">Generating and Parsing FATFS on Host</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Manufacturing Utility</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="#workflow">Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#csv-configuration-file">CSV Configuration File</a></li>
<li class="toctree-l4"><a class="reference internal" href="#master-value-csv-file">Master Value CSV File</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-utility">Running the utility</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="nvs_flash.html">Non-Volatile Storage Library</a></li>
<li class="toctree-l3"><a class="reference internal" href="nvs_bootloader.html">NVS Bootloader</a></li>
<li class="toctree-l3"><a class="reference internal" href="nvs_encryption.html">NVS Encryption</a></li>
<li class="toctree-l3"><a class="reference internal" href="nvs_partition_gen.html">NVS Partition Generator Utility</a></li>
<li class="toctree-l3"><a class="reference internal" href="nvs_partition_parse.html">NVS Partition Parser Utility</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdmmc.html">SD/SDIO/MMC Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="partition.html">Partitions API</a></li>
<li class="toctree-l3"><a class="reference internal" href="spiffs.html">SPIFFS Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="vfs.html">Virtual Filesystem Component</a></li>
<li class="toctree-l3"><a class="reference internal" href="wear-levelling.html">Wear Levelling API</a></li>
<li class="toctree-l3"><a class="reference internal" href="storage-security.html">Storage Security</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../system/index.html">System API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../hw-reference/index.html">Hardware Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api-guides/index.html">API Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../migration-guides/index.html">Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries-and-frameworks/index.html">Libraries and Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contributions Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../versions.html">ESP-IDF Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COPYRIGHT.html">Copyrights and Licenses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../languages.html">Switch Between Languages</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ESP-IDF Programming Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">API Reference</a></li>
          <li class="breadcrumb-item"><a href="index.html">Storage API</a></li>
      <li class="breadcrumb-item active">Manufacturing Utility</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/espressif/esp-idf/blob/v5.4.2/docs/en/api-reference/storage/mass_mfg.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="manufacturing-utility">
<h1>Manufacturing Utility<a class="headerlink" href="#manufacturing-utility" title="Permalink to this heading"></a></h1>
<p><a class="reference external" href="../../../../../zh_CN/v5.4.2/esp32/api-reference/storage/mass_mfg.html">[中文]</a></p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>This utility is designed to create instances of factory NVS partition images on a per-device basis for mass manufacturing purposes. The NVS partition images are created from CSV files containing user-provided configurations and values.</p>
<p>Please note that this utility only creates manufacturing binary images which then need to be flashed onto your devices using:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/espressif/esptool/#readme">esptool.py</a></p></li>
<li><dl class="simple">
<dt><a class="reference external" href="https://www.espressif.com/en/support/download/other-tools?keys=flash+download+tools">Flash Download tool</a> (available on Windows only)</dt><dd><ul>
<li><p>Download and unzip it, and follow the instructions inside the <em>doc</em> folder.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Direct flash programming using custom production tools.</p></li>
</ul>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading"></a></h2>
<p><strong>This utility is dependent on ESP-IDF's NVS Partition Generator Utility.</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>Operating System requirements:</dt><dd><ul>
<li><p>Linux / MacOS / Windows (standard distributions)</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>The following packages are needed to use this utility:</dt><dd><ul>
<li><p><a class="reference external" href="https://www.python.org/downloads/">Python</a></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<dl class="simple">
<dt>Before using this utility, please make sure that:</dt><dd><ul class="simple">
<li><p>The path to Python is added to the PATH environment variable.</p></li>
<li><p>You have installed the packages from <cite>requirement.txt</cite>, the file in the root of the ESP-IDF directory.</p></li>
</ul>
</dd>
</dl>
</div>
</section>
<section id="workflow">
<h2>Workflow<a class="headerlink" href="#workflow" title="Permalink to this heading"></a></h2>
<div class="align-default"><img height="120" src="../../_images/blockdiag-521e17e4026763a820fc4e354da2d8496627510c.png" width="640" /></div>
</section>
<section id="csv-configuration-file">
<h2>CSV Configuration File<a class="headerlink" href="#csv-configuration-file" title="Permalink to this heading"></a></h2>
<p>This file contains the configuration of the device to be flashed.</p>
<p>The data in the configuration file has the following format (the <cite>REPEAT</cite> tag is optional):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">name1</span><span class="p">,</span><span class="n">namespace</span><span class="p">,</span>    <span class="o">&lt;--</span> <span class="n">First</span> <span class="n">entry</span> <span class="n">should</span> <span class="n">be</span> <span class="n">of</span> <span class="nb">type</span> <span class="s2">&quot;namespace&quot;</span>
<span class="n">key1</span><span class="p">,</span><span class="n">type1</span><span class="p">,</span><span class="n">encoding1</span>
<span class="n">key2</span><span class="p">,</span><span class="n">type2</span><span class="p">,</span><span class="n">encoding2</span><span class="p">,</span><span class="n">REPEAT</span>
<span class="n">name2</span><span class="p">,</span><span class="n">namespace</span><span class="p">,</span>
<span class="n">key3</span><span class="p">,</span><span class="n">type3</span><span class="p">,</span><span class="n">encoding3</span>
<span class="n">key4</span><span class="p">,</span><span class="n">type4</span><span class="p">,</span><span class="n">encoding4</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The first line in this file should always be the <code class="docutils literal notranslate"><span class="pre">namespace</span></code> entry.</p>
</div>
<p>Each line should have three parameters: <code class="docutils literal notranslate"><span class="pre">key,type,encoding</span></code>, separated by a comma.
If the <code class="docutils literal notranslate"><span class="pre">REPEAT</span></code> tag is present, the value corresponding to this key in the master value CSV file will be the same for all devices.</p>
<p><em>Please refer to README of the NVS Partition Generator Utility for detailed description of each parameter.</em></p>
<p>Below is a sample example of such a configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="p">,</span><span class="n">namespace</span><span class="p">,</span>
<span class="n">firmware_key</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">hex2bin</span>
<span class="n">serial_no</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">string</span><span class="p">,</span><span class="n">REPEAT</span>
<span class="n">device_no</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">i32</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<dl class="simple">
<dt>Make sure there are <strong>no spaces</strong>:</dt><dd><ul class="simple">
<li><p>before and after ','</p></li>
<li><p>at the end of each line in a CSV file</p></li>
</ul>
</dd>
</dl>
</div>
</section>
<section id="master-value-csv-file">
<h2>Master Value CSV File<a class="headerlink" href="#master-value-csv-file" title="Permalink to this heading"></a></h2>
<p>This file contains details of the devices to be flashed. Each line in this file corresponds to a device instance.</p>
<p>The data in the master value CSV file has the following format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">key1</span><span class="p">,</span><span class="n">key2</span><span class="p">,</span><span class="n">key3</span><span class="p">,</span><span class="o">.....</span>
<span class="n">value1</span><span class="p">,</span><span class="n">value2</span><span class="p">,</span><span class="n">value3</span><span class="p">,</span><span class="o">....</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The first line in the file should always contain the <code class="docutils literal notranslate"><span class="pre">key</span></code> names. All the keys from the configuration file should be present here in the <strong>same order</strong>. This file can have additional columns (keys). The additional keys will be treated as metadata and would not be part of the final binary files.</p>
</div>
<p>Each line should contain the <code class="docutils literal notranslate"><span class="pre">value</span></code> of the corresponding keys, separated by a comma. If the key has the <code class="docutils literal notranslate"><span class="pre">REPEAT</span></code> tag, its corresponding value <strong>must</strong> be entered in the second line only. Keep the entry empty for this value in the following lines.</p>
<p>The description of this parameter is as follows:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">value</span></code></dt><dd><p>Data value</p>
</dd>
</dl>
<p>Data value is the value of data corresponding to the key.</p>
<p>Below is a sample example of a master value CSV file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span><span class="p">,</span><span class="n">firmware_key</span><span class="p">,</span><span class="n">serial_no</span><span class="p">,</span><span class="n">device_no</span>
<span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">a2b3c4d5e6faabb</span><span class="p">,</span><span class="n">A1</span><span class="p">,</span><span class="mi">101</span>
<span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="n">a2b3c4d5e6fccdd</span><span class="p">,,</span><span class="mi">102</span>
<span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="n">a2b3c4d5e6feeff</span><span class="p">,,</span><span class="mi">103</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>If the 'REPEAT' tag is present, a new master value CSV file will be created in the same folder as the input Master CSV File with the values inserted at each line for the key with the 'REPEAT' tag</em>.</p>
</div>
<p>This utility creates intermediate CSV files which are used as input for the NVS partition utility to generate the binary files.</p>
<p>The format of this intermediate CSV file is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">key</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="n">value</span>
<span class="n">key</span><span class="p">,</span><span class="n">namespace</span><span class="p">,</span> <span class="p">,</span>
<span class="n">key1</span><span class="p">,</span><span class="n">type1</span><span class="p">,</span><span class="n">encoding1</span><span class="p">,</span><span class="n">value1</span>
<span class="n">key2</span><span class="p">,</span><span class="n">type2</span><span class="p">,</span><span class="n">encoding2</span><span class="p">,</span><span class="n">value2</span>
</pre></div>
</div>
<p>An instance of an intermediate CSV file will be created for each device on an individual basis.</p>
</section>
<section id="running-the-utility">
<h2>Running the utility<a class="headerlink" href="#running-the-utility" title="Permalink to this heading"></a></h2>
<p><strong>Usage</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">mfg_gen</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">{</span><span class="n">generate</span><span class="p">,</span><span class="n">generate</span><span class="o">-</span><span class="n">key</span><span class="p">}</span> <span class="o">...</span>
</pre></div>
</div>
<p><strong>Optional Arguments</strong>:</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>No.</p></th>
<th class="head"><p>Parameter</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">-h</span></code> / <code class="docutils literal notranslate"><span class="pre">--help</span></code></p></td>
<td><p>Show the help message and exit</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><strong>Commands</strong>:</p>
<blockquote>
<div><blockquote>
<div><p>Run mfg_gen.py {command} -h for additional help</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>No.</p></th>
<th class="head"><p>Parameter</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">generate</span></code></p></td>
<td><p>Generate NVS partition</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">generate-key</span></code></p></td>
<td><p>Generate keys for encryption</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><strong>To generate factory images for each device (Default):</strong></p>
<p><strong>Usage</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">mfg_gen</span><span class="o">.</span><span class="n">py</span> <span class="n">generate</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">fileid</span> <span class="n">FILEID</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">version</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">}]</span> <span class="p">[</span><span class="o">--</span><span class="n">keygen</span><span class="p">]</span>
                                <span class="p">[</span><span class="o">--</span><span class="n">inputkey</span> <span class="n">INPUTKEY</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">outdir</span> <span class="n">OUTDIR</span><span class="p">]</span>
                                <span class="p">[</span><span class="o">--</span><span class="n">key_protect_hmac</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">kp_hmac_keygen</span><span class="p">]</span>
                                <span class="p">[</span><span class="o">--</span><span class="n">kp_hmac_keyfile</span> <span class="n">KP_HMAC_KEYFILE</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">kp_hmac_inputkey</span> <span class="n">KP_HMAC_INPUTKEY</span><span class="p">]</span>
                                <span class="n">conf</span> <span class="n">values</span> <span class="n">prefix</span> <span class="n">size</span>
</pre></div>
</div>
<p><strong>Positional Arguments</strong>:</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">conf</span></code></p></td>
<td><p>Path to configuration csv file to parse</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">values</span></code></p></td>
<td><p>Path to values csv file to parse</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">prefix</span></code></p></td>
<td><p>Unique name for each output filename prefix</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">size</span></code></p></td>
<td><p>Size of NVS partition in bytes (must be multiple of 4096)</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><strong>Optional Arguments</strong>:</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-h</span></code> / <code class="docutils literal notranslate"><span class="pre">--help</span></code></p></td>
<td><p>Show the help message and exit</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--fileid</span> <span class="pre">FILEID</span></code></p></td>
<td><p>Unique file identifier (any key in values file)
for each filename suffix (Default: numeric value(1,2,3...))</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--version</span> <span class="pre">{1,2}</span></code></p></td>
<td><p>Set multipage blob version. (Default: Version 2)</p>
<p>Version 1 - Multipage blob support disabled.</p>
<p>Version 2 - Multipage blob support enabled.</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--keygen</span></code></p></td>
<td><p>Generates key for encrypting NVS partition</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--inputkey</span> <span class="pre">INPUTKEY</span></code></p></td>
<td><p>File having key for encrypting NVS partition</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--outdir</span> <span class="pre">OUTDIR</span></code></p></td>
<td><p>Output directory to store files created (Default: current directory)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--key_protect_hmac</span></code></p></td>
<td><p>If set, the NVS encryption key protection scheme based on HMAC
peripheral is used; else the default scheme based on Flash Encryption
is used</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--kp_hmac_keygen</span></code></p></td>
<td><p>Generate the HMAC key for HMAC-based encryption scheme</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--kp_hmac_keyfile</span> <span class="pre">KP_HMAC_KEYFILE</span></code></p></td>
<td><p>Path to output HMAC key file</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--kp_hmac_inputkey</span> <span class="pre">KP_HMAC_INPUTKEY</span></code></p></td>
<td><p>File having the HMAC key for generating the NVS encryption keys</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>You can run the utility to generate factory images for each device using the command below. A sample CSV file is provided with the utility:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">mfg_gen</span><span class="o">.</span><span class="n">py</span> <span class="n">generate</span> <span class="n">samples</span><span class="o">/</span><span class="n">sample_config</span><span class="o">.</span><span class="n">csv</span> <span class="n">samples</span><span class="o">/</span><span class="n">sample_values_singlepage_blob</span><span class="o">.</span><span class="n">csv</span> <span class="n">Sample</span> <span class="mh">0x3000</span>
</pre></div>
</div>
<p>The master value CSV file should have the path in the <code class="docutils literal notranslate"><span class="pre">file</span></code> type relative to the directory from which you are running the utility.</p>
<p><strong>To generate encrypted factory images for each device:</strong></p>
<p>You can run the utility to encrypt factory images for each device using the command below. A sample CSV file is provided with the utility:</p>
<ul>
<li><p>Encrypt by allowing the utility to generate encryption keys:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">mfg_gen</span><span class="o">.</span><span class="n">py</span> <span class="n">generate</span> <span class="n">samples</span><span class="o">/</span><span class="n">sample_config</span><span class="o">.</span><span class="n">csv</span> <span class="n">samples</span><span class="o">/</span><span class="n">sample_values_singlepage_blob</span><span class="o">.</span><span class="n">csv</span> <span class="n">Sample</span> <span class="mh">0x3000</span> <span class="o">--</span><span class="n">keygen</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Encryption key of the following format <code class="docutils literal notranslate"><span class="pre">&lt;outdir&gt;/keys/keys-&lt;prefix&gt;-&lt;fileid&gt;.bin</span></code> is created. This newly created file having encryption keys in <code class="docutils literal notranslate"><span class="pre">keys/</span></code> directory is compatible with NVS key-partition structure. Refer to <a class="reference internal" href="nvs_encryption.html#nvs-encr-key-partition"><span class="std std-ref">NVS Key Partition</span></a> for more details.</p>
</div>
<ul>
<li><p>To generate an encrypted image using the HMAC-based scheme, the above command can be used alongwith some additional parameters.</p>
<blockquote>
<div><ul>
<li><p>Encrypt by allowing the utility to generate encryption keys and the HMAC-key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">mfg_gen</span><span class="o">.</span><span class="n">py</span> <span class="n">generate</span> <span class="n">samples</span><span class="o">/</span><span class="n">sample_config</span><span class="o">.</span><span class="n">csv</span> <span class="n">samples</span><span class="o">/</span><span class="n">sample_values_singlepage_blob</span><span class="o">.</span><span class="n">csv</span> <span class="n">Sample</span> <span class="mh">0x3000</span> <span class="o">--</span><span class="n">keygen</span> <span class="o">--</span><span class="n">key_protect_hmac</span> <span class="o">--</span><span class="n">kp_hmac_keygen</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Encryption key of the format <code class="docutils literal notranslate"><span class="pre">&lt;outdir&gt;/keys/keys-&lt;timestamp&gt;.bin</span></code> and HMAC key of the format <code class="docutils literal notranslate"><span class="pre">&lt;outdir&gt;/keys/hmac-keys-&lt;timestamp&gt;.bin</span></code> are created.</p>
</div>
</div></blockquote>
</li>
<li><p>Encrypt by allowing the utility to generate encryption keys with user-provided HMAC-key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">mfg_gen</span><span class="o">.</span><span class="n">py</span> <span class="n">generate</span> <span class="n">samples</span><span class="o">/</span><span class="n">sample_config</span><span class="o">.</span><span class="n">csv</span> <span class="n">samples</span><span class="o">/</span><span class="n">sample_values_singlepage_blob</span><span class="o">.</span><span class="n">csv</span> <span class="n">Sample</span> <span class="mh">0x3000</span> <span class="o">--</span><span class="n">keygen</span> <span class="o">--</span><span class="n">key_protect_hmac</span> <span class="o">--</span><span class="n">kp_hmac_inputkey</span> <span class="n">testdata</span><span class="o">/</span><span class="n">sample_hmac_key</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can provide the custom filename for the HMAC key as well as the encryption key as a parameter.</p>
</div>
<ul>
<li><p>Encrypt by providing the encryption keys as input binary file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">mfg_gen</span><span class="o">.</span><span class="n">py</span> <span class="n">generate</span> <span class="n">samples</span><span class="o">/</span><span class="n">sample_config</span><span class="o">.</span><span class="n">csv</span> <span class="n">samples</span><span class="o">/</span><span class="n">sample_values_singlepage_blob</span><span class="o">.</span><span class="n">csv</span> <span class="n">Sample</span> <span class="mh">0x3000</span> <span class="o">--</span><span class="n">inputkey</span> <span class="n">keys</span><span class="o">/</span><span class="n">sample_keys</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
</li>
</ul>
<p><strong>To generate only encryption keys:</strong></p>
<dl>
<dt><strong>Usage</strong>::</dt><dd><p>python mfg_gen.py generate-key [-h] [--keyfile KEYFILE] [--outdir OUTDIR]</p>
</dd>
<dt><strong>Optional Arguments</strong>:</dt><dd><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-h</span></code> / <code class="docutils literal notranslate"><span class="pre">--help</span></code></p></td>
<td><p>Show the help message and exit</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--keyfile</span> <span class="pre">KEYFILE</span></code></p></td>
<td><p>Path to output encryption keys file</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--outdir</span> <span class="pre">OUTDIR</span></code></p></td>
<td><p>Output directory to store files created. (Default: current directory)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--key_protect_hmac</span></code></p></td>
<td><p>If set, the NVS encryption key protection scheme based on HMAC
peripheral is used; else the default scheme based on Flash Encryption
is used</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--kp_hmac_keygen</span></code></p></td>
<td><p>Generate the HMAC key for HMAC-based encryption scheme</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--kp_hmac_keyfile</span> <span class="pre">KP_HMAC_KEYFILE</span></code></p></td>
<td><p>Path to output HMAC key file</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--kp_hmac_inputkey</span> <span class="pre">KP_HMAC_INPUTKEY</span></code></p></td>
<td><p>File having the HMAC key for generating the NVS encryption keys</p></td>
</tr>
</tbody>
</table>
</dd>
</dl>
<p>You can run the utility to generate only encryption keys using the command below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">mfg_gen</span><span class="o">.</span><span class="n">py</span> <span class="n">generate</span><span class="o">-</span><span class="n">key</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Encryption key of the following format <code class="docutils literal notranslate"><span class="pre">&lt;outdir&gt;/keys/keys-&lt;timestamp&gt;.bin</span></code> is created. Timestamp format is: <code class="docutils literal notranslate"><span class="pre">%m-%d_%H-%M</span></code>. To provide custom target filename use the --keyfile argument.</p>
</div>
<p>For generating encryption key for the HMAC-based scheme, the following commands can be used:</p>
<ul>
<li><p>Generate the HMAC key and the NVS encryption keys:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">mfg_gen</span><span class="o">.</span><span class="n">py</span> <span class="n">generate</span><span class="o">-</span><span class="n">key</span> <span class="o">--</span><span class="n">key_protect_hmac</span> <span class="o">--</span><span class="n">kp_hmac_keygen</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Encryption key of the format <code class="docutils literal notranslate"><span class="pre">&lt;outdir&gt;/keys/keys-&lt;timestamp&gt;.bin</span></code> and HMAC key of the format <code class="docutils literal notranslate"><span class="pre">&lt;outdir&gt;/keys/hmac-keys-&lt;timestamp&gt;.bin</span></code> are created.</p>
</div>
<ul>
<li><p>Generate the NVS encryption keys, given the HMAC-key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">mfg_gen</span><span class="o">.</span><span class="n">py</span> <span class="n">generate</span><span class="o">-</span><span class="n">key</span> <span class="o">--</span><span class="n">key_protect_hmac</span> <span class="o">--</span><span class="n">kp_hmac_inputkey</span> <span class="n">testdata</span><span class="o">/</span><span class="n">sample_hmac_key</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can provide the custom filename for the HMAC key as well as the encryption key as a parameter.</p>
</div>
<p>Generated encryption key binary file can further be used to encrypt factory images created on the per device basis.</p>
<p>The default numeric value: 1,2,3... of the <code class="docutils literal notranslate"><span class="pre">fileid</span></code> argument corresponds to each line bearing device instance values in the master value CSV file.</p>
<p>While running the manufacturing utility, the following folders will be created in the specified <code class="docutils literal notranslate"><span class="pre">outdir</span></code> directory:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bin/</span></code> for storing the generated binary files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">csv/</span></code> for storing the generated intermediate CSV files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">keys/</span></code> for storing encryption keys (when generating encrypted factory images)</p></li>
</ul>
</section>
</section>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

           </div>
             <div class="articleComments">

<style>
    .expand-feedback-content {
        display: none;
    }
    .click-like-or-dislike {
        background-color: #d3d3d3;
        pointer-events: none;
    }
</style>

<script>
    function submitFeedbackForm(user_likes_document) {
        // Send to GA4 the user reaction
        gtag('event', 'user_reaction', {
            'user_likes_document': user_likes_document
        });

        if (user_likes_document === 1) {
            document.querySelector('.like-btn').classList.add('click-like-or-dislike');
            document.getElementById("expandContentLike").style.display = 'block';
        } else {
            document.querySelector('.dislike-btn').classList.add('click-like-or-dislike');
            document.getElementById("expandContent").style.display = 'block';
        }

        document.querySelector('.like-btn').style.pointerEvents = 'none';
        document.querySelector('.dislike-btn').style.pointerEvents = 'none';
    }
</script>

<hr>

<p style="text-align:center"><strong>Was this page helpful?</strong></p>
<p style="text-align:center">
    <button class="like-btn" onclick="submitFeedbackForm(1)">
        <svg aria-hidden="true" focusable="false" class="color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" style="display:inline-block;user-select:none;vertical-align:text-bottom;overflow:visible">
            <path d="M8.834.066c.763.087 1.5.295 2.01.884.505.581.656 1.378.656 2.3 0 .467-.087 1.119-.157 1.637L11.328 5h1.422c.603 0 1.174.085 1.668.333.508.254.911.679 1.137 1.2.453.998.438 2.447.188 4.316l-.04.306c-.105.79-.195 1.473-.313 2.033-.131.63-.315 1.209-.668 1.672C13.97 15.847 12.706 16 11 16c-1.848 0-3.234-.333-4.388-.653-.165-.045-.323-.09-.475-.133-.658-.186-1.2-.34-1.725-.415A1.75 1.75 0 0 1 2.75 16h-1A1.75 1.75 0 0 1 0 14.25v-7.5C0 5.784.784 5 1.75 5h1a1.75 1.75 0 0 1 1.514.872c.258-.105.59-.268.918-.508C5.853 4.874 6.5 4.079 6.5 2.75v-.5c0-1.202.994-2.337 2.334-2.184ZM4.5 13.3c.705.088 1.39.284 2.072.478l.441.125c1.096.305 2.334.598 3.987.598 1.794 0 2.28-.223 2.528-.549.147-.193.276-.505.394-1.07.105-.502.188-1.124.295-1.93l.04-.3c.25-1.882.189-2.933-.068-3.497a.921.921 0 0 0-.442-.48c-.208-.104-.52-.174-.997-.174H11c-.686 0-1.295-.577-1.206-1.336.023-.192.05-.39.076-.586.065-.488.13-.97.13-1.328 0-.809-.144-1.15-.288-1.316-.137-.158-.402-.304-1.048-.378C8.357 1.521 8 1.793 8 2.25v.5c0 1.922-.978 3.128-1.933 3.825a5.831 5.831 0 0 1-1.567.81ZM2.75 6.5h-1a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h1a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
        </svg>
    </button>
    <button class="dislike-btn" onclick="submitFeedbackForm(0)">
        <svg aria-hidden="true" focusable="false" class="" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" style="display:inline-block;user-select:none;vertical-align:text-bottom;overflow:visible">
            <path d="M7.083 15.986c-.763-.087-1.499-.295-2.011-.884-.504-.581-.655-1.378-.655-2.299 0-.468.087-1.12.157-1.638l.015-.112H3.167c-.603 0-1.174-.086-1.669-.334a2.415 2.415 0 0 1-1.136-1.2c-.454-.998-.438-2.447-.188-4.316l.04-.306C.32 4.108.41 3.424.526 2.864c.132-.63.316-1.209.669-1.672C1.947.205 3.211.053 4.917.053c1.848 0 3.234.332 4.388.652l.474.133c.658.187 1.201.341 1.726.415a1.75 1.75 0 0 1 1.662-1.2h1c.966 0 1.75.784 1.75 1.75v7.5a1.75 1.75 0 0 1-1.75 1.75h-1a1.75 1.75 0 0 1-1.514-.872c-.259.105-.59.268-.919.508-.671.491-1.317 1.285-1.317 2.614v.5c0 1.201-.994 2.336-2.334 2.183Zm4.334-13.232c-.706-.089-1.39-.284-2.072-.479l-.441-.125c-1.096-.304-2.335-.597-3.987-.597-1.794 0-2.28.222-2.529.548-.147.193-.275.505-.393 1.07-.105.502-.188 1.124-.295 1.93l-.04.3c-.25 1.882-.19 2.933.067 3.497a.923.923 0 0 0 .443.48c.208.104.52.175.997.175h1.75c.685 0 1.295.577 1.205 1.335-.022.192-.049.39-.075.586-.066.488-.13.97-.13 1.329 0 .808.144 1.15.288 1.316.137.157.401.303 1.048.377.307.035.664-.237.664-.693v-.5c0-1.922.978-3.127 1.932-3.825a5.878 5.878 0 0 1 1.568-.809Zm1.75 6.798h1a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25h-1a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25Z"></path>
        </svg>
    </button>
</p>

<div class="expand-feedback-content" id="expandContentLike">
    <ul style="text-align:center">
        <li>Thank you! We received your feedback.</li>
        <li>If you have any comments, fill in <a href='https://www.espressif.com/en/company/documents/documentation_feedback?docId=4287&sections=Manufacturing Utility (api-reference/storage/mass_mfg)&version=esp32 v5.4.2 (v5.4.2)'>Espressif Documentation Feedback Form</a>.</li>
    </ul>
</div>

<div class="expand-feedback-content" id="expandContent">
    <ul style="text-align:center">
        <li>We value your feedback.</li>
        <li>Let us know how we can improve this page by filling in <a href='https://www.espressif.com/en/company/documents/documentation_feedback?docId=4287&sections=Manufacturing Utility (api-reference/storage/mass_mfg)&version=esp32 v5.4.2 (v5.4.2)'>Espressif Documentation Feedback Form</a>.</li>
    </ul>
</div>

<br>


             </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="fatfsgen.html" class="btn btn-neutral float-left" title="Generating and Parsing FATFS on Host" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="nvs_flash.html" class="btn btn-neutral float-right" title="Non-Volatile Storage Library" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016 - 2025, Espressif Systems (Shanghai) Co., Ltd.</p>
  </div>

  <ul class="footer">
        <li>
	    
            
            Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/espressif/sphinx_idf_theme">theme</a>  based on <a href="https://github.com/readthedocs/sphinx_rtd_theme">Read the Docs Sphinx Theme</a>.
         </li>
    <li class="footer-aside">
        <a href="../../esp-idf-en-v5.4.2.zip"> Download HTML</a>
    </li>

  </ul> 

</footer>
        </div>
      </div>
    </section>
  </div>

  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>