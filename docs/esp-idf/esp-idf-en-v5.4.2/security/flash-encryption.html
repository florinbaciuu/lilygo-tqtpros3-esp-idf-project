<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-73KGWFC8DM"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-73KGWFC8DM');
        </script><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flash Encryption - ESP32 -  &mdash; ESP-IDF Programming Guide v5.4.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=a60756f2" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=949a1ff5" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=851bd809" />

  
    <link rel="canonical" href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/security/flash-encryption.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=c241bbaf"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=ff8fa330"></script>
        <script src="https://wavedrom.com/skins/default.js"></script>
        <script src="https://wavedrom.com/wavedrom.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>

    
        

    <script type="text/javascript">
        DOCUMENTATION_OPTIONS.PAGENAME = 'security/flash-encryption';
        DOCUMENTATION_OPTIONS.PROJECT_SLUG = 'esp-idf';
        DOCUMENTATION_OPTIONS.LATEST_BRANCH_NAME = 'master';
        DOCUMENTATION_OPTIONS.VERSIONS_URL = 'https://dl.espressif.com/dl/esp-idf/idf_versions.js';
        DOCUMENTATION_OPTIONS.LANGUAGES = ["en", "zh_CN"];
        DOCUMENTATION_OPTIONS.IDF_TARGET = 'esp32';
        DOCUMENTATION_OPTIONS.HAS_IDF_TARGETS = ["esp32", "esp32s2", "esp32s3", "esp32c3", "esp32c2", "esp32c5", "esp32c6", "esp32p4"]
        DOCUMENTATION_OPTIONS.RELEASE = 'v5.4.2';
        DOCUMENTATION_OPTIONS.LANGUAGE_URL = 'en';

    </script>

    <script type="text/javascript" src="https://dl.espressif.com/dl/esp-idf/idf_versions.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Secure Boot" href="secure-boot-v1.html" />
    <link rel="prev" title="Security Overview" href="security.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ESP-IDF Programming Guide
              <img src="../_static/espressif-logo.svg" class="logo" alt="Logo"/>
          </a>

          
            <div class="selectors">
              <select id="target-select" style="width: 150px;" hidden>
                <option value="" disabled selected>Choose target...</option>
              </select>
            </div>
          

          <div class="selectors">
            <select id="version-select" style="width: 150px;" hidden>
              <option value="" disabled selected>Choose version...</option>
            </select>
          </div>

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../get-started/index.html">Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hw-reference/index.html">Hardware Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-guides/index.html">API Guides</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Security Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="security.html">Security Overview</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Flash Encryption</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#encrypted-partitions">Encrypted Partitions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#relevant-efuses">Relevant eFuses</a></li>
<li class="toctree-l3"><a class="reference internal" href="#flash-encryption-process">Flash Encryption Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="#flash-encryption-configuration">Flash Encryption Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#development-mode">Development Mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#release-mode">Release Mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#enable-flash-encryption-externally">Enable Flash Encryption Externally</a></li>
<li class="toctree-l3"><a class="reference internal" href="#possible-failures">Possible Failures</a></li>
<li class="toctree-l3"><a class="reference internal" href="#esp32-flash-encryption-status">ESP32 Flash Encryption Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reading-and-writing-data-in-encrypted-flash">Reading and Writing Data in Encrypted Flash</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#scope-of-flash-encryption">Scope of Flash Encryption</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reading-from-encrypted-flash">Reading from Encrypted Flash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-to-encrypted-flash">Writing to Encrypted Flash</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#updating-encrypted-flash">Updating Encrypted Flash</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ota-updates">OTA Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="#updating-encrypted-flash-via-serial">Updating Encrypted Flash via Serial</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#disabling-flash-encryption">Disabling Flash Encryption</a></li>
<li class="toctree-l3"><a class="reference internal" href="#key-points-about-flash-encryption">Key Points About Flash Encryption</a></li>
<li class="toctree-l3"><a class="reference internal" href="#limitations-of-flash-encryption">Limitations of Flash Encryption</a></li>
<li class="toctree-l3"><a class="reference internal" href="#flash-encryption-and-secure-boot">Flash Encryption and Secure Boot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#advanced-features">Advanced Features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#encrypted-partition-flag">Encrypted Partition Flag</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enabling-uart-bootloader-encryption-decryption">Enabling UART Bootloader Encryption/Decryption</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-flash-crypt-config">Setting FLASH_CRYPT_CONFIG</a></li>
<li class="toctree-l4"><a class="reference internal" href="#jtag-debugging">JTAG Debugging</a></li>
<li class="toctree-l4"><a class="reference internal" href="#manually-encrypting-files">Manually Encrypting Files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#technical-details">Technical Details</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#flash-encryption-algorithm">Flash Encryption Algorithm</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="secure-boot-v1.html">Secure Boot</a></li>
<li class="toctree-l2"><a class="reference internal" href="secure-boot-v2.html">Secure Boot v2</a></li>
<li class="toctree-l2"><a class="reference internal" href="security-features-enablement-workflows.html">Security Features Enablement Workflows</a></li>
<li class="toctree-l2"><a class="reference internal" href="vulnerabilities.html">Vulnerabilities</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../migration-guides/index.html">Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../libraries-and-frameworks/index.html">Libraries and Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contributions Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">ESP-IDF Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COPYRIGHT.html">Copyrights and Licenses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages.html">Switch Between Languages</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ESP-IDF Programming Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Security Guides</a></li>
      <li class="breadcrumb-item active">Flash Encryption</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/espressif/esp-idf/blob/v5.4.2/docs/en/security/flash-encryption.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="flash-encryption">
<h1>Flash Encryption<a class="headerlink" href="#flash-encryption" title="Permalink to this heading"></a></h1>
<p><a class="reference external" href="../../../../zh_CN/v5.4.2/esp32/security/flash-encryption.html">[中文]</a></p>
<p>This is a quick start guide to ESP32's flash encryption feature. Using application code as an example, it demonstrates how to test and verify flash encryption operations during development and production.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this guide, most used commands are in the form of <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">secure-&lt;command&gt;</span></code>, which is a wrapper around corresponding <code class="docutils literal notranslate"><span class="pre">espsecure.py</span> <span class="pre">&lt;command&gt;</span></code>. The <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> based commands provides more user-friendly experience, although may lack some of the advanced functionality of their <code class="docutils literal notranslate"><span class="pre">espsecure.py</span></code> based counterparts.</p>
</div>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>Flash encryption is intended for encrypting the contents of the ESP32's off-chip flash memory. Once this feature is enabled, firmware is flashed as plaintext, and then the data is encrypted in place on the first boot. As a result, physical readout of flash will not be sufficient to recover most flash contents.</p>
<p><a class="reference internal" href="secure-boot-v2.html"><span class="doc">Secure Boot</span></a> is a separate feature which can be used together with flash encryption to create an even more secure environment.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>For production use, flash encryption should be enabled in the &quot;Release&quot; mode only.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Enabling flash encryption limits the options for further updates of ESP32. Before using this feature, read the document and make sure to understand the implications.</p>
</div>
</section>
<section id="encrypted-partitions">
<span id="id1"></span><h2>Encrypted Partitions<a class="headerlink" href="#encrypted-partitions" title="Permalink to this heading"></a></h2>
<p>With flash encryption enabled, the following types of data are encrypted by default:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api-guides/startup.html#second-stage-bootloader"><span class="std std-ref">Second Stage Bootloader</span></a></p></li>
<li><p>Partition Table</p></li>
<li><p><a class="reference internal" href="../api-reference/storage/nvs_encryption.html#nvs-encr-key-partition"><span class="std std-ref">NVS Key Partition</span></a></p></li>
<li><p>Otadata</p></li>
<li><p>All <code class="docutils literal notranslate"><span class="pre">app</span></code> type partitions</p></li>
</ul>
<p>Other types of data can be encrypted conditionally:</p>
<ul class="simple">
<li><p>Any partition marked with the <code class="docutils literal notranslate"><span class="pre">encrypted</span></code> flag in the partition table. For details, see <a class="reference internal" href="#encrypted-partition-flag"><span class="std std-ref">Encrypted Partition Flag</span></a>.</p></li>
<li><p>Secure Boot bootloader digest if Secure Boot is enabled (see below).</p></li>
</ul>
</section>
<section id="relevant-efuses">
<span id="flash-encryption-efuse"></span><h2>Relevant eFuses<a class="headerlink" href="#relevant-efuses" title="Permalink to this heading"></a></h2>
<p>The flash encryption operation is controlled by various eFuses available on ESP32. The list of eFuses and their descriptions is given in the table below. The names in eFuse column are also used by <code class="docutils literal notranslate"><span class="pre">espefuse.py</span></code> tool and <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> based eFuse commands. For usage in the eFuse API, modify the name by adding <code class="docutils literal notranslate"><span class="pre">ESP_EFUSE_</span></code>, for example: esp_efuse_read_field_bit (ESP_EFUSE_DISABLE_DL_ENCRYPT).</p>
<table class="docutils align-default" id="id7">
<caption><span class="caption-text">eFuses Used in Flash Encryption</span><a class="headerlink" href="#id7" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 33.3%" />
<col style="width: 53.3%" />
<col style="width: 13.3%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>eFuse</strong></p></td>
<td><p><strong>Description</strong></p></td>
<td><p><strong>Bit Depth</strong></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CODING_SCHEME</span></code></p></td>
<td><p>Controls actual number of block1 bits used to derive final 256-bit AES key. Possible values: <code class="docutils literal notranslate"><span class="pre">0</span></code> for 256 bits, <code class="docutils literal notranslate"><span class="pre">1</span></code> for 192 bits, <code class="docutils literal notranslate"><span class="pre">2</span></code> for 128 bits. Final AES key is derived based on the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CONFIG</span></code> value.</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">flash_encryption</span></code> (block1)</p></td>
<td><p>AES key storage.</p></td>
<td><p>256 bit key block</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CONFIG</span></code></p></td>
<td><p>Controls the AES encryption process.</p></td>
<td><p>4</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DISABLE_DL_ENCRYPT</span></code></p></td>
<td><p>If set, disables flash encryption operation while running in Firmware Download mode.</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DISABLE_DL_DECRYPT</span></code></p></td>
<td><p>If set, disables flash decryption while running in UART Firmware Download mode.</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code></p></td>
<td><p>A <span class="math notranslate nohighlight">\(2^n\)</span> number that indicating whether the contents of flash have been encrypted.</p>
<ul class="simple">
<li><p>If an odd number of bits are set (e.g., <code class="docutils literal notranslate"><span class="pre">0b0000001</span></code> or <code class="docutils literal notranslate"><span class="pre">0b0000111</span></code>), this indicates the contents of flash are encrypted. The contents will need to be transparently decrypted when read.</p></li>
<li><p>If an even number of bits are set (e.g., <code class="docutils literal notranslate"><span class="pre">0b0000000</span></code> or <code class="docutils literal notranslate"><span class="pre">0b0000011</span></code>), this indicates the contents of flash are unencrypted (i.e., plain text).</p></li>
</ul>
<p>With each successive unencrypted flash update (e.g., flashing a new unencrypted binary) and encryption of the flash (via the <a class="reference internal" href="../api-reference/kconfig.html#config-secure-flash-enc-enabled"><span class="std std-ref">Enable flash encryption on boot</span></a> option), the next MSB of <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> is set.</p>
</td>
<td><p>7</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>R/W access control is available for all the eFuse bits listed in the table above.</p></li>
<li><p>The default value of these bits is 0 after manufacturing.</p></li>
</ul>
</div>
<p>Read and write access to eFuse bits is controlled by appropriate fields in the registers <code class="docutils literal notranslate"><span class="pre">WR_DIS</span></code> and <code class="docutils literal notranslate"><span class="pre">RD_DIS</span></code>. For more information on ESP32 eFuses, see <a class="reference internal" href="../api-reference/system/efuse.html"><span class="doc">eFuse manager</span></a>. To change protection bits of eFuse field using <code class="docutils literal notranslate"><span class="pre">idf.py</span></code>, use these two commands: efuse-read-protect and efuse-write-protect (idf.py based aliases of espefuse.py commands write_protect_efuse and read_protect_efuse). Example <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">efuse-write-protect</span> <span class="pre">DISABLE_DL_ENCRYPT</span></code>.</p>
</section>
<section id="flash-encryption-process">
<h2>Flash Encryption Process<a class="headerlink" href="#flash-encryption-process" title="Permalink to this heading"></a></h2>
<p>Assuming that the eFuse values are in their default states and the second stage bootloader is compiled to support flash encryption, the flash encryption process executes as shown below:</p>
<ol class="arabic simple">
<li><p>On the first power-on reset, all data in flash is un-encrypted (plaintext). The first stage (ROM) bootloader loads the second stage bootloader.</p></li>
<li><p>Second stage bootloader reads the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> eFuse value (<code class="docutils literal notranslate"><span class="pre">0b0000000</span></code>). Since the value is <code class="docutils literal notranslate"><span class="pre">0</span></code> (even number of bits set), it configures and enables the flash encryption block. It also sets the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CONFIG</span></code> eFuse to 0xF. For more information on the flash encryption block, see <em>ESP32 Technical Reference Manual</em> &gt; <em>eFuse Controller (eFuse)</em> &gt; <em>Flash Encryption Block</em> [<a class="reference external" href="https://www.espressif.com/sites/default/files/documentation/esp32_technical_reference_manual_en.pdf#efuse">PDF</a>].</p></li>
<li><p>Second stage bootloader first checks if a valid key is already present in the eFuse (e.g., burned using espefuse tool), then the process of key generation is skipped and the same key is used for flash encryption process. Otherwise, Second stage bootloader uses RNG (random) module to generate an AES-256 bit key and then writes it into the <code class="docutils literal notranslate"><span class="pre">flash_encryption</span></code> eFuse. The key cannot be accessed via software as the write and read protection bits for the <code class="docutils literal notranslate"><span class="pre">flash_encryption</span></code> eFuse are set. The flash encryption operations happen entirely by hardware, and the key cannot be accessed via software.</p></li>
<li><p>Flash encryption block encrypts the flash contents - the second stage bootloader, applications and partitions marked as <code class="docutils literal notranslate"><span class="pre">encrypted</span></code>. Encrypting in-place can take time, up to a minute for large partitions.</p></li>
<li><p>Second stage bootloader sets the first available bit in <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> (0b0000001) to mark the flash contents as encrypted. Odd number of bits is set.</p></li>
<li><p>For <a class="reference internal" href="#flash-enc-development-mode"><span class="std std-ref">Development Mode</span></a>, the second stage bootloader sets only the eFuse bits <code class="docutils literal notranslate"><span class="pre">DISABLE_DL_DECRYPT</span></code> and <code class="docutils literal notranslate"><span class="pre">DISABLE_DL_CACHE</span></code> to allow the UART bootloader to re-flash encrypted binaries. Also, the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> eFuse bits are NOT write-protected.</p></li>
<li><p>For <a class="reference internal" href="#flash-enc-release-mode"><span class="std std-ref">Release Mode</span></a>, the second stage bootloader sets the eFuse bits <code class="docutils literal notranslate"><span class="pre">DISABLE_DL_ENCRYPT</span></code>, <code class="docutils literal notranslate"><span class="pre">DISABLE_DL_DECRYPT</span></code>, and <code class="docutils literal notranslate"><span class="pre">DISABLE_DL_CACHE</span></code> to 1 to prevent the UART bootloader from decrypting the flash contents. It also write-protects the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> eFuse bits. To modify this behavior, see <a class="reference internal" href="#uart-bootloader-encryption"><span class="std std-ref">Enabling UART Bootloader Encryption/Decryption</span></a>.</p></li>
<li><p>The device is then rebooted to start executing the encrypted image. The second stage bootloader calls the flash decryption block to decrypt the flash contents and then loads the decrypted contents into IRAM.</p></li>
</ol>
<p>During the development stage, there is a frequent need to program different plaintext flash images and test the flash encryption process. This requires that Firmware Download mode is able to load new plaintext images as many times as it might be needed. However, during manufacturing or production stages, Firmware Download mode should not be allowed to access flash contents for security reasons.</p>
<p>Hence, two different flash encryption configurations were created: for development and for production. For details on these configurations, see Section <a class="reference internal" href="#flash-encryption-configuration">Flash Encryption Configuration</a>.</p>
</section>
<section id="flash-encryption-configuration">
<h2>Flash Encryption Configuration<a class="headerlink" href="#flash-encryption-configuration" title="Permalink to this heading"></a></h2>
<p>The following flash encryption modes are available:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#flash-enc-development-mode"><span class="std std-ref">Development Mode</span></a> - recommended for use only during development. In this mode, it is still possible to flash new plaintext firmware to the device, and the bootloader will transparently encrypt this firmware using the key stored in hardware. This allows, indirectly, to read out the plaintext of the firmware in flash.</p></li>
<li><p><a class="reference internal" href="#flash-enc-release-mode"><span class="std std-ref">Release Mode</span></a> - recommended for manufacturing and production. In this mode, flashing plaintext firmware to the device without knowing the encryption key is no longer possible.</p></li>
</ul>
<p>This section provides information on the mentioned flash encryption modes and step by step instructions on how to use them.</p>
<section id="development-mode">
<span id="flash-enc-development-mode"></span><h3>Development Mode<a class="headerlink" href="#development-mode" title="Permalink to this heading"></a></h3>
<p>During development, you can encrypt flash using either an ESP32 generated key or external host-generated key.</p>
<section id="using-esp32-generated-key">
<h4>Using ESP32 Generated Key<a class="headerlink" href="#using-esp32-generated-key" title="Permalink to this heading"></a></h4>
<p>Development mode allows you to download multiple plaintext images using Firmware Download mode.</p>
<p>To test flash encryption process, take the following steps:</p>
<ol class="arabic simple">
<li><p>Ensure that you have an ESP32 device with default flash encryption eFuse settings as shown in <a class="reference internal" href="#flash-encryption-efuse"><span class="std std-ref">Relevant eFuses</span></a>.</p></li>
</ol>
<blockquote>
<div><p>See how to check <a class="reference internal" href="#flash-encryption-status"><span class="std std-ref">ESP32 Flash Encryption Status</span></a>.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>In <a class="reference internal" href="../api-reference/kconfig.html#project-configuration-menu"><span class="std std-ref">Project Configuration Menu</span></a>, do the following:</p></li>
</ol>
<blockquote>
<div><p><ul class="simple">
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-secure-flash-enc-enabled"><span class="std std-ref">Enable flash encryption on boot</span></a>.</p></li>
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-secure-flash-encryption-mode"><span class="std std-ref">Select encryption mode</span></a> (<strong>Development mode</strong> by default).</p></li>
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-secure-uart-rom-dl-mode"><span class="std std-ref">Select UART ROM download mode</span></a> (<strong>enabled</strong> by default). Note that for the ESP32 target, the choice is only available when <a class="reference internal" href="../api-reference/kconfig.html#config-esp32-rev-min"><span class="std std-ref">CONFIG_ESP32_REV_MIN</span></a> level is set to 3 (ESP32 V3).</p></li>
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-bootloader-log-level"><span class="std std-ref">Select the appropriate bootloader log verbosity</span></a>.</p></li>
<li><p>Save the configuration and exit.</p></li>
</ul>
</p>
</div></blockquote>
<p>Enabling flash encryption will increase the size of bootloader, which might require updating partition table offset. See <a class="reference internal" href="../api-guides/bootloader.html#bootloader-size"><span class="std std-ref">Bootloader Size</span></a>.</p>
<ol class="arabic simple" start="3">
<li><p>Run the command given below to build and flash the complete images.</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py<span class="w"> </span>flash<span class="w"> </span>monitor
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This command does not include any user files which should be written to the partitions on the flash memory. Please write them manually before running this command otherwise the files should be encrypted separately before writing.</p>
</div>
<p>This command will write to flash memory unencrypted images: the second stage bootloader, the partition table and applications. Once the flashing is complete, ESP32 will reset. On the next boot, the second stage bootloader encrypts: the second stage bootloader, application partitions and partitions marked as <code class="docutils literal notranslate"><span class="pre">encrypted</span></code> then resets. Encrypting in-place can take time, up to a minute for large partitions. After that, the application is decrypted at runtime and executed.</p>
</div></blockquote>
<p>A sample output of the first ESP32 boot after enabling flash encryption is given below:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>--- idf_monitor on /dev/cu.SLAB_USBtoUART 115200 ---
--- Quit: Ctrl+] | Menu: Ctrl+T | Help: Ctrl+T followed by Ctrl+H ---
ets Jun  8 2016 00:22:57

rst:0x1 (POWERON_RESET),boot:0x13 (SPI_FAST_FLASH_BOOT)
configsip: 0, SPIWP:0xee
clk_drv:0x00,q_drv:0x00,d_drv:0x00,cs0_drv:0x00,hd_drv:0x00,wp_drv:0x00
mode:DIO, clock div:2
load:0x3fff0018,len:4
load:0x3fff001c,len:8452
load:0x40078000,len:13608
load:0x40080400,len:6664
entry 0x40080764
I (28) boot: ESP-IDF v4.0-dev-850-gc4447462d-dirty 2nd stage bootloader
I (29) boot: compile time 15:37:14
I (30) boot: Enabling RNG early entropy source...
I (35) boot: SPI Speed      : 40MHz
I (39) boot: SPI Mode       : DIO
I (43) boot: SPI Flash Size : 4MB
I (47) boot: Partition Table:
I (51) boot: ## Label            Usage          Type ST Offset   Length
I (58) boot:  0 nvs              WiFi data        01 02 0000a000 00006000
I (66) boot:  1 phy_init         RF data          01 01 00010000 00001000
I (73) boot:  2 factory          factory app      00 00 00020000 00100000
I (81) boot: End of partition table
I (85) esp_image: segment 0: paddr=0x00020020 vaddr=0x3f400020 size=0x0808c ( 32908) map
I (105) esp_image: segment 1: paddr=0x000280b4 vaddr=0x3ffb0000 size=0x01ea4 (  7844) load
I (109) esp_image: segment 2: paddr=0x00029f60 vaddr=0x40080000 size=0x00400 (  1024) load
0x40080000: _WindowOverflow4 at esp-idf/esp-idf/components/freertos/xtensa_vectors.S:1778

I (114) esp_image: segment 3: paddr=0x0002a368 vaddr=0x40080400 size=0x05ca8 ( 23720) load
I (132) esp_image: segment 4: paddr=0x00030018 vaddr=0x400d0018 size=0x126a8 ( 75432) map
0x400d0018: _flash_cache_start at ??:?

I (159) esp_image: segment 5: paddr=0x000426c8 vaddr=0x400860a8 size=0x01f4c (  8012) load
0x400860a8: prvAddNewTaskToReadyList at esp-idf/esp-idf/components/freertos/tasks.c:4561

I (168) boot: Loaded app from partition at offset 0x20000
I (168) boot: Checking flash encryption...
I (168) flash_encrypt: Generating new flash encryption key...
I (187) flash_encrypt: Read &amp; write protecting new key...
I (187) flash_encrypt: Setting CRYPT_CONFIG efuse to 0xF
W (188) flash_encrypt: Not disabling UART bootloader encryption
I (195) flash_encrypt: Disable UART bootloader decryption...
I (201) flash_encrypt: Disable UART bootloader MMU cache...
I (208) flash_encrypt: Disable JTAG...
I (212) flash_encrypt: Disable ROM BASIC interpreter fallback...
I (219) esp_image: segment 0: paddr=0x00001020 vaddr=0x3fff0018 size=0x00004 (     4)
I (227) esp_image: segment 1: paddr=0x0000102c vaddr=0x3fff001c size=0x02104 (  8452)
I (239) esp_image: segment 2: paddr=0x00003138 vaddr=0x40078000 size=0x03528 ( 13608)
I (249) esp_image: segment 3: paddr=0x00006668 vaddr=0x40080400 size=0x01a08 (  6664)
I (657) esp_image: segment 0: paddr=0x00020020 vaddr=0x3f400020 size=0x0808c ( 32908) map
I (669) esp_image: segment 1: paddr=0x000280b4 vaddr=0x3ffb0000 size=0x01ea4 (  7844)
I (672) esp_image: segment 2: paddr=0x00029f60 vaddr=0x40080000 size=0x00400 (  1024)
0x40080000: _WindowOverflow4 at esp-idf/esp-idf/components/freertos/xtensa_vectors.S:1778

I (676) esp_image: segment 3: paddr=0x0002a368 vaddr=0x40080400 size=0x05ca8 ( 23720)
I (692) esp_image: segment 4: paddr=0x00030018 vaddr=0x400d0018 size=0x126a8 ( 75432) map
0x400d0018: _flash_cache_start at ??:?

I (719) esp_image: segment 5: paddr=0x000426c8 vaddr=0x400860a8 size=0x01f4c (  8012)
0x400860a8: prvAddNewTaskToReadyList at esp-idf/esp-idf/components/freertos/tasks.c:4561

I (722) flash_encrypt: Encrypting partition 2 at offset 0x20000...
I (13229) flash_encrypt: Flash encryption completed
I (13229) boot: Resetting with flash encryption enabled...
</pre></div>
</div>
<p>A sample output of subsequent ESP32 boots just mentions that flash encryption is already enabled:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rst:0x1 (POWERON_RESET),boot:0x13 (SPI_FAST_FLASH_BOOT)
configsip: 0, SPIWP:0xee
clk_drv:0x00,q_drv:0x00,d_drv:0x00,cs0_drv:0x00,hd_drv:0x00,wp_drv:0x00
mode:DIO, clock div:2
load:0x3fff0018,len:4
load:0x3fff001c,len:8452
load:0x40078000,len:13652
ho 0 tail 12 room 4
load:0x40080400,len:6664
entry 0x40080764
I (30) boot: ESP-IDF v4.0-dev-850-gc4447462d-dirty 2nd stage bootloader
I (30) boot: compile time 16:32:53
I (31) boot: Enabling RNG early entropy source...
I (37) boot: SPI Speed      : 40MHz
I (41) boot: SPI Mode       : DIO
I (45) boot: SPI Flash Size : 4MB
I (49) boot: Partition Table:
I (52) boot: ## Label            Usage          Type ST Offset   Length
I (60) boot:  0 nvs              WiFi data        01 02 0000a000 00006000
I (67) boot:  1 phy_init         RF data          01 01 00010000 00001000
I (75) boot:  2 factory          factory app      00 00 00020000 00100000
I (82) boot: End of partition table
I (86) esp_image: segment 0: paddr=0x00020020 vaddr=0x3f400020 size=0x0808c ( 32908) map
I (107) esp_image: segment 1: paddr=0x000280b4 vaddr=0x3ffb0000 size=0x01ea4 (  7844) load
I (111) esp_image: segment 2: paddr=0x00029f60 vaddr=0x40080000 size=0x00400 (  1024) load
0x40080000: _WindowOverflow4 at esp-idf/esp-idf/components/freertos/xtensa_vectors.S:1778

I (116) esp_image: segment 3: paddr=0x0002a368 vaddr=0x40080400 size=0x05ca8 ( 23720) load
I (134) esp_image: segment 4: paddr=0x00030018 vaddr=0x400d0018 size=0x126a8 ( 75432) map
0x400d0018: _flash_cache_start at ??:?

I (162) esp_image: segment 5: paddr=0x000426c8 vaddr=0x400860a8 size=0x01f4c (  8012) load
0x400860a8: prvAddNewTaskToReadyList at esp-idf/esp-idf/components/freertos/tasks.c:4561

I (171) boot: Loaded app from partition at offset 0x20000
I (171) boot: Checking flash encryption...
I (171) flash_encrypt: flash encryption is enabled (3 plaintext flashes left)
I (178) boot: Disabling RNG early entropy source...
I (184) cpu_start: Pro cpu up.
I (188) cpu_start: Application information:
I (193) cpu_start: Project name:     flash-encryption
I (198) cpu_start: App version:      v4.0-dev-850-gc4447462d-dirty
I (205) cpu_start: Compile time:     Jun 17 2019 16:32:52
I (211) cpu_start: ELF file SHA256:  8770c886bdf561a7...
I (217) cpu_start: ESP-IDF:          v4.0-dev-850-gc4447462d-dirty
I (224) cpu_start: Starting app cpu, entry point is 0x40080e4c
0x40080e4c: call_start_cpu1 at esp-idf/esp-idf/components/esp32/cpu_start.c:265

I (0) cpu_start: App cpu up.
I (235) heap_init: Initializing. RAM available for dynamic allocation:
I (241) heap_init: At 3FFAE6E0 len 00001920 (6 KiB): DRAM
I (247) heap_init: At 3FFB2EC8 len 0002D138 (180 KiB): DRAM
I (254) heap_init: At 3FFE0440 len 00003AE0 (14 KiB): D/IRAM
I (260) heap_init: At 3FFE4350 len 0001BCB0 (111 KiB): D/IRAM
I (266) heap_init: At 40087FF4 len 0001800C (96 KiB): IRAM
I (273) cpu_start: Pro cpu start user code
I (291) cpu_start: Starting scheduler on PRO CPU.
I (0) cpu_start: Starting scheduler on APP CPU.

Sample program to check Flash Encryption
This is ESP32 chip with 2 CPU cores, WiFi/BT/BLE, silicon revision 1, 4MB external flash
Flash encryption feature is enabled
Flash encryption mode is DEVELOPMENT
Flash in encrypted mode with flash_crypt_cnt = 1
Halting...
</pre></div>
</div>
<p>At this stage, if you need to update and re-flash binaries, see <a class="reference internal" href="#encrypt-partitions"><span class="std std-ref">Re-flashing Updated Partitions</span></a>.</p>
</section>
<section id="using-host-generated-key">
<span id="pregenerated-flash-encryption-key"></span><h4>Using Host Generated Key<a class="headerlink" href="#using-host-generated-key" title="Permalink to this heading"></a></h4>
<p>It is possible to pre-generate a flash encryption key on the host computer and burn it into the eFuse. This allows you to pre-encrypt data on the host and flash already encrypted data without needing a plaintext flash update. This feature can be used in both <a class="reference internal" href="#flash-enc-development-mode"><span class="std std-ref">Development Mode</span></a> and <a class="reference internal" href="#flash-enc-release-mode"><span class="std std-ref">Release Mode</span></a>. Without a pre-generated key, data is flashed in plaintext and then ESP32 encrypts the data in-place.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This option is not recommended for production, unless a separate key is generated for each individual device.</p>
</div>
<p>To use a host generated key, take the following steps:</p>
<ol class="arabic simple">
<li><p>Ensure that you have an ESP32 device with default flash encryption eFuse settings as shown in <a class="reference internal" href="#flash-encryption-efuse"><span class="std std-ref">Relevant eFuses</span></a>.</p></li>
</ol>
<blockquote>
<div><p>See how to check <a class="reference internal" href="#flash-encryption-status"><span class="std std-ref">ESP32 Flash Encryption Status</span></a>.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Generate a random key by running:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py<span class="w"> </span>secure-generate-flash-encryption-key<span class="w"> </span>my_flash_encryption_key.bin
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p><strong>Before the first encrypted boot</strong>, burn the key into your device's eFuse using the command below. This action can be done <strong>only once</strong>.</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py<span class="w"> </span>--port<span class="w"> </span>PORT<span class="w"> </span>efuse-burn-key<span class="w"> </span>flash_encryption<span class="w"> </span>my_flash_encryption_key.bin
</pre></div>
</div>
<p>If the key is not burned and the device is started after enabling flash encryption, the ESP32 will generate a random key that software cannot access or modify.</p>
</div></blockquote>
<ol class="arabic" start="4">
<li><p>In <a class="reference internal" href="../api-reference/kconfig.html#project-configuration-menu"><span class="std std-ref">Project Configuration Menu</span></a>, do the following:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-secure-flash-enc-enabled"><span class="std std-ref">Enable flash encryption on boot</span></a></p></li>
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-secure-flash-encryption-mode"><span class="std std-ref">Select encryption mode</span></a> (<strong>Development mode</strong> by default)</p></li>
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-bootloader-log-level"><span class="std std-ref">Select the appropriate bootloader log verbosity</span></a></p></li>
<li><p>Save the configuration and exit.</p></li>
</ul>
</div></blockquote>
</li>
</ol>
<p>Enabling flash encryption will increase the size of bootloader, which might require updating partition table offset. See <a class="reference internal" href="../api-guides/bootloader.html#bootloader-size"><span class="std std-ref">Bootloader Size</span></a>.</p>
<ol class="arabic simple" start="5">
<li><p>Run the command given below to build and flash the complete images.</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py<span class="w"> </span>flash<span class="w"> </span>monitor
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This command does not include any user files which should be written to the partitions on the flash memory. Please write them manually before running this command otherwise the files should be encrypted separately before writing.</p>
</div>
<p>This command will write to flash memory unencrypted images: the second stage bootloader, the partition table and applications. Once the flashing is complete, ESP32 will reset. On the next boot, the second stage bootloader encrypts: the second stage bootloader, application partitions and partitions marked as <code class="docutils literal notranslate"><span class="pre">encrypted</span></code> then resets. Encrypting in-place can take time, up to a minute for large partitions. After that, the application is decrypted at runtime and executed.</p>
</div></blockquote>
<p>If using Development Mode, then the easiest way to update and re-flash binaries is <a class="reference internal" href="#encrypt-partitions"><span class="std std-ref">Re-flashing Updated Partitions</span></a>.</p>
<p>If using Release Mode, then it is possible to pre-encrypt the binaries on the host and then flash them as ciphertext. See <a class="reference internal" href="#manual-encryption"><span class="std std-ref">Manually Encrypting Files</span></a>.</p>
</section>
<section id="re-flashing-updated-partitions">
<span id="encrypt-partitions"></span><h4>Re-flashing Updated Partitions<a class="headerlink" href="#re-flashing-updated-partitions" title="Permalink to this heading"></a></h4>
<p>If you update your application code (done in plaintext) and want to re-flash it, you will need to encrypt it before flashing. To encrypt the application and flash it in one step, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py<span class="w"> </span>encrypted-app-flash<span class="w"> </span>monitor
</pre></div>
</div>
<p>If all partitions needs to be updated in encrypted format, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py<span class="w"> </span>encrypted-flash<span class="w"> </span>monitor
</pre></div>
</div>
</section>
</section>
<section id="release-mode">
<span id="flash-enc-release-mode"></span><h3>Release Mode<a class="headerlink" href="#release-mode" title="Permalink to this heading"></a></h3>
<p>In Release mode, UART bootloader cannot perform flash encryption operations. New plaintext images can ONLY be downloaded using the over-the-air (OTA) scheme which will encrypt the plaintext image before writing to flash.</p>
<p>To use this mode, take the following steps:</p>
<ol class="arabic simple">
<li><p>Ensure that you have an ESP32 device with default flash encryption eFuse settings as shown in <a class="reference internal" href="#flash-encryption-efuse"><span class="std std-ref">Relevant eFuses</span></a>.</p></li>
</ol>
<blockquote>
<div><p>See how to check <a class="reference internal" href="#flash-encryption-status"><span class="std std-ref">ESP32 Flash Encryption Status</span></a>.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>In <a class="reference internal" href="../api-reference/kconfig.html#project-configuration-menu"><span class="std std-ref">Project Configuration Menu</span></a>, do the following:</p></li>
</ol>
<blockquote>
<div><p><ul class="simple">
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-secure-flash-enc-enabled"><span class="std std-ref">Enable flash encryption on boot</span></a>.</p></li>
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-secure-flash-encryption-mode"><span class="std std-ref">Select Release mode</span></a>. (Note that once Release mode is selected, the <code class="docutils literal notranslate"><span class="pre">DISABLE_DL_ENCRYPT</span></code> and <code class="docutils literal notranslate"><span class="pre">DISABLE_DL_DECRYPT</span></code> eFuse bits will be burned to disable flash encryption hardware in ROM Download Mode.)</p></li>
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-secure-uart-rom-dl-mode"><span class="std std-ref">Select UART ROM download mode (Permanently disabled (recommended))</span></a> (Note that this option is only available when <a class="reference internal" href="../api-reference/kconfig.html#config-esp32-rev-min"><span class="std std-ref">CONFIG_ESP32_REV_MIN</span></a> is set to 3 (ESP32 V3).) The default choice is to keep UART ROM download mode enabled, however it is recommended to permanently disable this mode to reduce the options available to an attacker.</p></li>
<li><p><a class="reference internal" href="../api-reference/kconfig.html#config-bootloader-log-level"><span class="std std-ref">Select the appropriate bootloader log verbosity</span></a>.</p></li>
<li><p>Save the configuration and exit.</p></li>
</ul>
</p>
</div></blockquote>
<p>Enabling flash encryption will increase the size of bootloader, which might require updating partition table offset. See <a class="reference internal" href="../api-guides/bootloader.html#bootloader-size"><span class="std std-ref">Bootloader Size</span></a>.</p>
<ol class="arabic simple" start="3">
<li><p>Run the command given below to build and flash the complete images.</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py<span class="w"> </span>flash<span class="w"> </span>monitor
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This command does not include any user files which should be written to the partitions on the flash memory. Please write them manually before running this command otherwise the files should be encrypted separately before writing.</p>
</div>
<p>This command will write to flash memory unencrypted images: the second stage bootloader, the partition table and applications. Once the flashing is complete, ESP32 will reset. On the next boot, the second stage bootloader encrypts: the second stage bootloader, application partitions and partitions marked as <code class="docutils literal notranslate"><span class="pre">encrypted</span></code> then resets. Encrypting in-place can take time, up to a minute for large partitions. After that, the application is decrypted at runtime and executed.</p>
</div></blockquote>
<p>Once the flash encryption is enabled in Release mode, the bootloader will write-protect the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> eFuse.</p>
<p>For subsequent plaintext field updates, use <a class="reference internal" href="#updating-encrypted-flash-ota"><span class="std std-ref">OTA scheme</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have pre-generated the flash encryption key and stored a copy, and the UART download mode is not permanently disabled via <a class="reference internal" href="../api-reference/kconfig.html#config-secure-uart-rom-dl-mode"><span class="std std-ref">CONFIG_SECURE_UART_ROM_DL_MODE</span></a> (ESP32 V3 only), then it is possible to update the flash locally by pre-encrypting the files and then flashing the ciphertext. See <a class="reference internal" href="#manual-encryption"><span class="std std-ref">Manually Encrypting Files</span></a>.</p>
</div>
</section>
<section id="best-practices">
<span id="flash-encrypt-best-practices"></span><h3>Best Practices<a class="headerlink" href="#best-practices" title="Permalink to this heading"></a></h3>
<p>When using Flash Encryption in production:</p>
<p><ul class="simple">
<li><p>Do not reuse the same flash encryption key between multiple devices. This means that an attacker who copies encrypted data from one device cannot transfer it to a second device.</p></li>
<li><p>When using ESP32 V3, if the UART ROM Download Mode is not needed for a production device then it should be disabled to provide an extra level of protection. Do this by calling <a class="reference internal" href="../api-reference/system/efuse.html#_CPPv435esp_efuse_disable_rom_download_modev" title="esp_efuse_disable_rom_download_mode"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">esp_efuse_disable_rom_download_mode()</span></code></a> during application startup. Alternatively, configure the project <a class="reference internal" href="../api-reference/kconfig.html#config-esp32-rev-min"><span class="std std-ref">CONFIG_ESP32_REV_MIN</span></a> level to 3 (targeting ESP32 V3 only) and select the <a class="reference internal" href="../api-reference/kconfig.html#config-secure-uart-rom-dl-mode"><span class="std std-ref">CONFIG_SECURE_UART_ROM_DL_MODE</span></a> to &quot;Permanently disable ROM Download Mode (recommended)&quot;. The ability to disable ROM Download Mode is not available on earlier ESP32 versions.</p></li>
<li><p>Enable <a class="reference internal" href="secure-boot-v2.html"><span class="doc">Secure Boot</span></a> as an extra layer of protection, and to prevent an attacker from selectively corrupting any part of the flash before boot.</p></li>
</ul>
</p>
</section>
</section>
<section id="enable-flash-encryption-externally">
<h2>Enable Flash Encryption Externally<a class="headerlink" href="#enable-flash-encryption-externally" title="Permalink to this heading"></a></h2>
<p>In the process mentioned above, flash encryption related eFuses which ultimately enable flash encryption are programmed through the second stage bootloader. Alternatively, all the eFuses can be programmed with the help of <code class="docutils literal notranslate"><span class="pre">espefuse</span></code> tool. Please refer <a class="reference internal" href="security-features-enablement-workflows.html#enable-flash-encryption-externally"><span class="std std-ref">Enable Flash Encryption Externally</span></a> for more details.</p>
</section>
<section id="possible-failures">
<h2>Possible Failures<a class="headerlink" href="#possible-failures" title="Permalink to this heading"></a></h2>
<p>Once flash encryption is enabled, the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> eFuse value will have an odd number of bits set. It means that all the partitions marked with the encryption flag are expected to contain encrypted ciphertext. Below are the three typical failure cases if the ESP32 is erroneously loaded with plaintext data:</p>
<ol class="arabic simple">
<li><p>If the bootloader partition is re-flashed with a <strong>plaintext second stage bootloader image</strong>, the first stage (ROM) bootloader will fail to load the second stage bootloader resulting in the following failure:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rst:0x3<span class="w"> </span><span class="o">(</span>SW_RESET<span class="o">)</span>,boot:0x13<span class="w"> </span><span class="o">(</span>SPI_FAST_FLASH_BOOT<span class="o">)</span>
flash<span class="w"> </span><span class="nb">read</span><span class="w"> </span>err,<span class="w"> </span><span class="m">1000</span>
ets_main.c<span class="w"> </span><span class="m">371</span>
ets<span class="w"> </span>Jun<span class="w">  </span><span class="m">8</span><span class="w"> </span><span class="m">2016</span><span class="w"> </span><span class="m">00</span>:22:57

rst:0x7<span class="w"> </span><span class="o">(</span>TG0WDT_SYS_RESET<span class="o">)</span>,boot:0x13<span class="w"> </span><span class="o">(</span>SPI_FAST_FLASH_BOOT<span class="o">)</span>
flash<span class="w"> </span><span class="nb">read</span><span class="w"> </span>err,<span class="w"> </span><span class="m">1000</span>
ets_main.c<span class="w"> </span><span class="m">371</span>
ets<span class="w"> </span>Jun<span class="w">  </span><span class="m">8</span><span class="w"> </span><span class="m">2016</span><span class="w"> </span><span class="m">00</span>:22:57

rst:0x7<span class="w"> </span><span class="o">(</span>TG0WDT_SYS_RESET<span class="o">)</span>,boot:0x13<span class="w"> </span><span class="o">(</span>SPI_FAST_FLASH_BOOT<span class="o">)</span>
flash<span class="w"> </span><span class="nb">read</span><span class="w"> </span>err,<span class="w"> </span><span class="m">1000</span>
ets_main.c<span class="w"> </span><span class="m">371</span>
ets<span class="w"> </span>Jun<span class="w">  </span><span class="m">8</span><span class="w"> </span><span class="m">2016</span><span class="w"> </span><span class="m">00</span>:22:57

rst:0x7<span class="w"> </span><span class="o">(</span>TG0WDT_SYS_RESET<span class="o">)</span>,boot:0x13<span class="w"> </span><span class="o">(</span>SPI_FAST_FLASH_BOOT<span class="o">)</span>
flash<span class="w"> </span><span class="nb">read</span><span class="w"> </span>err,<span class="w"> </span><span class="m">1000</span>
ets_main.c<span class="w"> </span><span class="m">371</span>
ets<span class="w"> </span>Jun<span class="w">  </span><span class="m">8</span><span class="w"> </span><span class="m">2016</span><span class="w"> </span><span class="m">00</span>:22:57

rst:0x7<span class="w"> </span><span class="o">(</span>TG0WDT_SYS_RESET<span class="o">)</span>,boot:0x13<span class="w"> </span><span class="o">(</span>SPI_FAST_FLASH_BOOT<span class="o">)</span>
flash<span class="w"> </span><span class="nb">read</span><span class="w"> </span>err,<span class="w"> </span><span class="m">1000</span>
ets_main.c<span class="w"> </span><span class="m">371</span>
ets<span class="w"> </span>Jun<span class="w">  </span><span class="m">8</span><span class="w"> </span><span class="m">2016</span><span class="w"> </span><span class="m">00</span>:22:57
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This error also appears if the flash contents are erased or corrupted.</p>
</div>
<ol class="arabic simple" start="2">
<li><p>If the second stage bootloader is encrypted, but the partition table is re-flashed with a <strong>plaintext partition table image</strong>, the bootloader will fail to read the partition table resulting in the following failure:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rst:0x3<span class="w"> </span><span class="o">(</span>SW_RESET<span class="o">)</span>,boot:0x13<span class="w"> </span><span class="o">(</span>SPI_FAST_FLASH_BOOT<span class="o">)</span>
configsip:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>SPIWP:0xee
clk_drv:0x00,q_drv:0x00,d_drv:0x00,cs0_drv:0x00,hd_drv:0x00,wp_drv:0x00
mode:DIO,<span class="w"> </span>clock<span class="w"> </span>div:2
load:0x3fff0018,len:4
load:0x3fff001c,len:10464
ho<span class="w"> </span><span class="m">0</span><span class="w"> </span>tail<span class="w"> </span><span class="m">12</span><span class="w"> </span>room<span class="w"> </span><span class="m">4</span>
load:0x40078000,len:19168
load:0x40080400,len:6664
entry<span class="w"> </span>0x40080764
I<span class="w"> </span><span class="o">(</span><span class="m">60</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>ESP-IDF<span class="w"> </span>v4.0-dev-763-g2c55fae6c-dirty<span class="w"> </span>2nd<span class="w"> </span>stage<span class="w"> </span>bootloader
I<span class="w"> </span><span class="o">(</span><span class="m">60</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>compile<span class="w"> </span><span class="nb">time</span><span class="w"> </span><span class="m">19</span>:15:54
I<span class="w"> </span><span class="o">(</span><span class="m">62</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>Enabling<span class="w"> </span>RNG<span class="w"> </span>early<span class="w"> </span>entropy<span class="w"> </span>source...
I<span class="w"> </span><span class="o">(</span><span class="m">67</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>SPI<span class="w"> </span>Speed<span class="w">      </span>:<span class="w"> </span>40MHz
I<span class="w"> </span><span class="o">(</span><span class="m">72</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>SPI<span class="w"> </span>Mode<span class="w">       </span>:<span class="w"> </span>DIO
I<span class="w"> </span><span class="o">(</span><span class="m">76</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>SPI<span class="w"> </span>Flash<span class="w"> </span>Size<span class="w"> </span>:<span class="w"> </span>4MB
E<span class="w"> </span><span class="o">(</span><span class="m">80</span><span class="o">)</span><span class="w"> </span>flash_parts:<span class="w"> </span>partition<span class="w"> </span><span class="m">0</span><span class="w"> </span>invalid<span class="w"> </span>magic<span class="w"> </span>number<span class="w"> </span>0x94f6
E<span class="w"> </span><span class="o">(</span><span class="m">86</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>verify<span class="w"> </span>partition<span class="w"> </span>table
E<span class="w"> </span><span class="o">(</span><span class="m">91</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>load<span class="w"> </span>partition<span class="w"> </span>table<span class="w"> </span>error!
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>If the bootloader and partition table are encrypted, but the application is re-flashed with a <strong>plaintext application image</strong>, the bootloader will fail to load the application resulting in the following failure:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rst:0x3<span class="w"> </span><span class="o">(</span>SW_RESET<span class="o">)</span>,boot:0x13<span class="w"> </span><span class="o">(</span>SPI_FAST_FLASH_BOOT<span class="o">)</span>
configsip:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>SPIWP:0xee
clk_drv:0x00,q_drv:0x00,d_drv:0x00,cs0_drv:0x00,hd_drv:0x00,wp_drv:0x00
mode:DIO,<span class="w"> </span>clock<span class="w"> </span>div:2
load:0x3fff0018,len:4
load:0x3fff001c,len:8452
load:0x40078000,len:13616
load:0x40080400,len:6664
entry<span class="w"> </span>0x40080764
I<span class="w"> </span><span class="o">(</span><span class="m">56</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>ESP-IDF<span class="w"> </span>v4.0-dev-850-gc4447462d-dirty<span class="w"> </span>2nd<span class="w"> </span>stage<span class="w"> </span>bootloader
I<span class="w"> </span><span class="o">(</span><span class="m">56</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>compile<span class="w"> </span><span class="nb">time</span><span class="w"> </span><span class="m">15</span>:37:14
I<span class="w"> </span><span class="o">(</span><span class="m">58</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>Enabling<span class="w"> </span>RNG<span class="w"> </span>early<span class="w"> </span>entropy<span class="w"> </span>source...
I<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>SPI<span class="w"> </span>Speed<span class="w">      </span>:<span class="w"> </span>40MHz
I<span class="w"> </span><span class="o">(</span><span class="m">68</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>SPI<span class="w"> </span>Mode<span class="w">       </span>:<span class="w"> </span>DIO
I<span class="w"> </span><span class="o">(</span><span class="m">72</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>SPI<span class="w"> </span>Flash<span class="w"> </span>Size<span class="w"> </span>:<span class="w"> </span>4MB
I<span class="w"> </span><span class="o">(</span><span class="m">76</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>Partition<span class="w"> </span>Table:
I<span class="w"> </span><span class="o">(</span><span class="m">79</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span><span class="c1">## Label            Usage          Type ST Offset   Length</span>
I<span class="w"> </span><span class="o">(</span><span class="m">87</span><span class="o">)</span><span class="w"> </span>boot:<span class="w">  </span><span class="m">0</span><span class="w"> </span>nvs<span class="w">              </span>WiFi<span class="w"> </span>data<span class="w">        </span><span class="m">01</span><span class="w"> </span><span class="m">02</span><span class="w"> </span>0000a000<span class="w"> </span><span class="m">00006000</span>
I<span class="w"> </span><span class="o">(</span><span class="m">94</span><span class="o">)</span><span class="w"> </span>boot:<span class="w">  </span><span class="m">1</span><span class="w"> </span>phy_init<span class="w">         </span>RF<span class="w"> </span>data<span class="w">          </span><span class="m">01</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00010000</span><span class="w"> </span><span class="m">00001000</span>
I<span class="w"> </span><span class="o">(</span><span class="m">102</span><span class="o">)</span><span class="w"> </span>boot:<span class="w">  </span><span class="m">2</span><span class="w"> </span>factory<span class="w">          </span>factory<span class="w"> </span>app<span class="w">      </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00020000</span><span class="w"> </span><span class="m">00100000</span>
I<span class="w"> </span><span class="o">(</span><span class="m">109</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>End<span class="w"> </span>of<span class="w"> </span>partition<span class="w"> </span>table
E<span class="w"> </span><span class="o">(</span><span class="m">113</span><span class="o">)</span><span class="w"> </span>esp_image:<span class="w"> </span>image<span class="w"> </span>at<span class="w"> </span>0x20000<span class="w"> </span>has<span class="w"> </span>invalid<span class="w"> </span>magic<span class="w"> </span>byte
W<span class="w"> </span><span class="o">(</span><span class="m">120</span><span class="o">)</span><span class="w"> </span>esp_image:<span class="w"> </span>image<span class="w"> </span>at<span class="w"> </span>0x20000<span class="w"> </span>has<span class="w"> </span>invalid<span class="w"> </span>SPI<span class="w"> </span>mode<span class="w"> </span><span class="m">108</span>
W<span class="w"> </span><span class="o">(</span><span class="m">126</span><span class="o">)</span><span class="w"> </span>esp_image:<span class="w"> </span>image<span class="w"> </span>at<span class="w"> </span>0x20000<span class="w"> </span>has<span class="w"> </span>invalid<span class="w"> </span>SPI<span class="w"> </span>size<span class="w"> </span><span class="m">11</span>
E<span class="w"> </span><span class="o">(</span><span class="m">132</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>Factory<span class="w"> </span>app<span class="w"> </span>partition<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>bootable
E<span class="w"> </span><span class="o">(</span><span class="m">138</span><span class="o">)</span><span class="w"> </span>boot:<span class="w"> </span>No<span class="w"> </span>bootable<span class="w"> </span>app<span class="w"> </span>partitions<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>partition<span class="w"> </span>table
</pre></div>
</div>
</div></blockquote>
</section>
<section id="esp32-flash-encryption-status">
<span id="flash-encryption-status"></span><h2>ESP32 Flash Encryption Status<a class="headerlink" href="#esp32-flash-encryption-status" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Ensure that you have an ESP32 device with default flash encryption eFuse settings as shown in <a class="reference internal" href="#flash-encryption-efuse"><span class="std std-ref">Relevant eFuses</span></a>.</p></li>
</ol>
<p>To check if flash encryption on your ESP32 device is enabled, do one of the following:</p>
<ul>
<li><p>flash the application example <a class="reference external" href="https://github.com/espressif/esp-idf/tree/v5.4.2/examples/security/flash_encryption">security/flash_encryption</a> onto your device. This application prints the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> eFuse value and if flash encryption is enabled or disabled.</p></li>
<li><p><a class="reference internal" href="../get-started/establish-serial-connection.html"><span class="doc">Find the serial port name</span></a> under which your ESP32 device is connected, replace <code class="docutils literal notranslate"><span class="pre">PORT</span></code> with your port name in the following command, and run it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py<span class="w"> </span>efuse-summary
</pre></div>
</div>
</li>
</ul>
</section>
<section id="reading-and-writing-data-in-encrypted-flash">
<span id="reading-writing-content"></span><h2>Reading and Writing Data in Encrypted Flash<a class="headerlink" href="#reading-and-writing-data-in-encrypted-flash" title="Permalink to this heading"></a></h2>
<p>ESP32 application code can check if flash encryption is currently enabled by calling <a class="reference internal" href="../api-reference/peripherals/spi_flash/index.html#_CPPv428esp_flash_encryption_enabledv" title="esp_flash_encryption_enabled"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">esp_flash_encryption_enabled()</span></code></a>. Also, a device can identify the flash encryption mode by calling <a class="reference internal" href="../api-reference/peripherals/spi_flash/index.html#_CPPv429esp_get_flash_encryption_modev" title="esp_get_flash_encryption_mode"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">esp_get_flash_encryption_mode()</span></code></a>.</p>
<p>Once flash encryption is enabled, be more careful with accessing flash contents from code.</p>
<section id="scope-of-flash-encryption">
<h3>Scope of Flash Encryption<a class="headerlink" href="#scope-of-flash-encryption" title="Permalink to this heading"></a></h3>
<p>Whenever the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> eFuse is set to a value with an odd number of bits, all flash content accessed via the MMU's flash cache is transparently decrypted. It includes:</p>
<ul class="simple">
<li><p>Executable application code in flash (IROM).</p></li>
<li><p>All read-only data stored in flash (DROM).</p></li>
<li><p>Any data accessed via <a class="reference internal" href="../api-reference/peripherals/spi_flash/index.html#_CPPv414spi_flash_mmap6size_t6size_t23spi_flash_mmap_memory_tPPKvP23spi_flash_mmap_handle_t" title="spi_flash_mmap"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">spi_flash_mmap()</span></code></a>.</p></li>
<li><p>The second stage bootloader image when it is read by the first stage (ROM) bootloader.</p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The MMU flash cache unconditionally decrypts all existing data. Data which is stored unencrypted in flash memory will also be &quot;transparently decrypted&quot; via the flash cache and will appear to software as random garbage.</p>
</div>
</section>
<section id="reading-from-encrypted-flash">
<h3>Reading from Encrypted Flash<a class="headerlink" href="#reading-from-encrypted-flash" title="Permalink to this heading"></a></h3>
<p>To read data without using a flash cache MMU mapping, you can use the partition read function <a class="reference internal" href="../api-reference/storage/partition.html#_CPPv418esp_partition_readPK15esp_partition_t6size_tPv6size_t" title="esp_partition_read"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">esp_partition_read()</span></code></a>. This function will only decrypt data when it is read from an encrypted partition. Data read from unencrypted partitions will not be decrypted. In this way, software can access encrypted and non-encrypted flash in the same way.</p>
<p>You can also use the following SPI flash API functions:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api-reference/peripherals/spi_flash/index.html#_CPPv414esp_flash_readP11esp_flash_tPv8uint32_t8uint32_t" title="esp_flash_read"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">esp_flash_read()</span></code></a> to read raw (encrypted) data which will not be decrypted</p></li>
<li><p><a class="reference internal" href="../api-reference/peripherals/spi_flash/index.html#_CPPv424esp_flash_read_encryptedP11esp_flash_t8uint32_tPv8uint32_t" title="esp_flash_read_encrypted"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">esp_flash_read_encrypted()</span></code></a> to read and decrypt data</p></li>
</ul>
<p>Data stored using the Non-Volatile Storage (NVS) API is always stored and read decrypted from the perspective of flash encryption. It is up to the library to provide encryption feature if required. Refer to <a class="reference internal" href="../api-reference/storage/nvs_encryption.html"><span class="doc">NVS Encryption</span></a> for more details.</p>
</section>
<section id="writing-to-encrypted-flash">
<h3>Writing to Encrypted Flash<a class="headerlink" href="#writing-to-encrypted-flash" title="Permalink to this heading"></a></h3>
<p>It is recommended to use the partition write function <a class="reference internal" href="../api-reference/storage/partition.html#_CPPv419esp_partition_writePK15esp_partition_t6size_tPKv6size_t" title="esp_partition_write"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">esp_partition_write()</span></code></a>. This function will only encrypt data when it is written to an encrypted partition. Data written to unencrypted partitions will not be encrypted. In this way, software can access encrypted and non-encrypted flash in the same way.</p>
<p>You can also pre-encrypt and write data using the function <a class="reference internal" href="../api-reference/peripherals/spi_flash/index.html#_CPPv425esp_flash_write_encryptedP11esp_flash_t8uint32_tPKv8uint32_t" title="esp_flash_write_encrypted"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">esp_flash_write_encrypted()</span></code></a></p>
<p>Also, the following ROM function exist but not supported in esp-idf applications:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">esp_rom_spiflash_write_encrypted</span></code> pre-encrypts and writes data to flash</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SPIWrite</span></code> writes unencrypted data to flash</p></li>
</ul>
<p>Since data is encrypted in blocks, the minimum write size for encrypted data is 16 bytes and the alignment is also 16 bytes.</p>
</section>
</section>
<section id="updating-encrypted-flash">
<span id="id2"></span><h2>Updating Encrypted Flash<a class="headerlink" href="#updating-encrypted-flash" title="Permalink to this heading"></a></h2>
<section id="ota-updates">
<span id="updating-encrypted-flash-ota"></span><h3>OTA Updates<a class="headerlink" href="#ota-updates" title="Permalink to this heading"></a></h3>
<p>OTA updates to encrypted partitions will automatically write encrypted data if the function <a class="reference internal" href="../api-reference/storage/partition.html#_CPPv419esp_partition_writePK15esp_partition_t6size_tPKv6size_t" title="esp_partition_write"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">esp_partition_write()</span></code></a> is used.</p>
<p>Before building the application image for OTA updating of an already encrypted device, enable the option <a class="reference internal" href="../api-reference/kconfig.html#config-secure-flash-enc-enabled"><span class="std std-ref">Enable flash encryption on boot</span></a> in project configuration menu.</p>
<p>For general information about ESP-IDF OTA updates, please refer to <a class="reference internal" href="../api-reference/system/ota.html"><span class="doc">OTA</span></a>.</p>
</section>
<section id="updating-encrypted-flash-via-serial">
<span id="updating-encrypted-flash-serial"></span><h3>Updating Encrypted Flash via Serial<a class="headerlink" href="#updating-encrypted-flash-via-serial" title="Permalink to this heading"></a></h3>
<p>Flashing an encrypted device via serial bootloader requires that the serial bootloader download interface has not been permanently disabled via eFuse.</p>
<p>In Development Mode, the recommended method is <a class="reference internal" href="#encrypt-partitions"><span class="std std-ref">Re-flashing Updated Partitions</span></a>.</p>
<p>In Release Mode, if a copy of the same key stored in eFuse is available on the host then it is possible to pre-encrypt files on the host and then flash them. See <a class="reference internal" href="#manual-encryption"><span class="std std-ref">Manually Encrypting Files</span></a>.</p>
</section>
</section>
<section id="disabling-flash-encryption">
<h2>Disabling Flash Encryption<a class="headerlink" href="#disabling-flash-encryption" title="Permalink to this heading"></a></h2>
<p>If flash encryption was enabled accidentally, flashing of plaintext data will soft-brick the ESP32. The device will reboot continuously, printing the error <code class="docutils literal notranslate"><span class="pre">flash</span> <span class="pre">read</span> <span class="pre">err,</span> <span class="pre">1000</span></code> or <code class="docutils literal notranslate"><span class="pre">invalid</span> <span class="pre">header:</span> <span class="pre">0xXXXXXX</span></code>.</p>
<p>For flash encryption in Development mode, encryption can be disabled by burning the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> eFuse. It can only be done three times per chip by taking the following steps:</p>
<ol class="arabic simple">
<li><p>In <a class="reference internal" href="../api-reference/kconfig.html#project-configuration-menu"><span class="std std-ref">Project Configuration Menu</span></a>, disable <a class="reference internal" href="../api-reference/kconfig.html#config-secure-flash-enc-enabled"><span class="std std-ref">Enable flash encryption on boot</span></a>, then save and exit.</p></li>
<li><p>Open project configuration menu again and <strong>double-check</strong> that you have disabled this option! If this option is left enabled, the bootloader will immediately re-enable encryption when it boots.</p></li>
<li><p>With flash encryption disabled, build and flash the new bootloader and application by running <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">flash</span></code>.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> to disable the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> by running:</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py<span class="w"> </span>efuse-burn<span class="w"> </span>FLASH_CRYPT_CNT
</pre></div>
</div>
</div></blockquote>
<p>Reset the ESP32. Flash encryption will be disabled, and the bootloader will boot as usual.</p>
</section>
<section id="key-points-about-flash-encryption">
<h2>Key Points About Flash Encryption<a class="headerlink" href="#key-points-about-flash-encryption" title="Permalink to this heading"></a></h2>
<p><ul>
<li><p>Flash memory contents is encrypted using AES-256. The flash encryption key is stored in the <code class="docutils literal notranslate"><span class="pre">flash_encryption</span></code> eFuse internal to the chip and, by default, is protected from software access.</p></li>
<li><p>The flash encryption algorithm is AES-256, where the key is &quot;tweaked&quot; with the offset address of each 32 byte block of flash. This means that every 32-byte block (two consecutive 16 byte AES blocks) is encrypted with a unique key derived from the flash encryption key.</p></li>
<li><p>Flash access is transparent via the flash cache mapping feature of ESP32 - any flash regions which are mapped to the address space will be transparently decrypted when read.</p>
<p>Some data partitions might need to remain unencrypted for ease of access or might require the use of flash-friendly update algorithms which are ineffective if the data is encrypted. NVS partitions for non-volatile storage cannot be encrypted since the NVS library is not directly compatible with flash encryption. For details, refer to <a class="reference internal" href="../api-reference/storage/nvs_encryption.html"><span class="doc">NVS Encryption</span></a>.</p>
</li>
<li><p>If flash encryption might be used in future, the programmer must keep it in mind and take certain precautions when writing code that <a class="reference internal" href="#reading-writing-content"><span class="std std-ref">uses encrypted flash</span></a>.</p></li>
<li><p>If secure boot is enabled, re-flashing the bootloader of an encrypted device requires a &quot;Re-flashable&quot; secure boot digest (see <a class="reference internal" href="#flash-encryption-and-secure-boot"><span class="std std-ref">Flash Encryption and Secure Boot</span></a>).</p></li>
</ul>
</p>
<p>Enabling flash encryption will increase the size of bootloader, which might require updating partition table offset. See <a class="reference internal" href="../api-guides/bootloader.html#bootloader-size"><span class="std std-ref">Bootloader Size</span></a>.</p>
<blockquote>
<div><div class="admonition important">
<p class="admonition-title">Important</p>
<p>Do not interrupt power to the ESP32 while the first boot encryption pass is running. If power is interrupted, the flash contents will be corrupted and will require flashing with unencrypted data again. In this case, re-flashing will not count towards the flashing limit.</p>
</div>
</div></blockquote>
</section>
<section id="limitations-of-flash-encryption">
<span id="flash-encryption-limitations"></span><h2>Limitations of Flash Encryption<a class="headerlink" href="#limitations-of-flash-encryption" title="Permalink to this heading"></a></h2>
<p>Flash encryption protects firmware against unauthorised readout and modification. It is important to understand the limitations of the flash encryption feature:</p>
<p><ul class="simple">
<li><p>Flash encryption is only as strong as the key. For this reason, we recommend keys are generated on the device during first boot (default behaviour). If generating keys off-device, ensure proper procedure is followed and do not share the same key between all production devices.</p></li>
<li><p>Not all data is stored encrypted. If storing data on flash, check if the method you are using (library, API, etc.) supports flash encryption.</p></li>
<li><p>Flash encryption does not prevent an attacker from understanding the high-level layout of the flash. This is because the same AES key is used for every pair of adjacent 16 byte AES blocks. When these adjacent 16 byte blocks contain identical content (such as empty or padding areas), these blocks will encrypt to produce matching pairs of encrypted blocks. This may allow an attacker to make high-level comparisons between encrypted devices (i.e., to tell if two devices are probably running the same firmware version).</p></li>
<li><p>For the same reason, an attacker can always tell when a pair of adjacent 16 byte blocks (32 byte aligned) contain two identical 16 byte sequences. Keep this in mind if storing sensitive data on the flash, design your flash storage so this does not happen (using a counter byte or some other non-identical value every 16 bytes is sufficient). <a class="reference internal" href="../api-reference/storage/nvs_encryption.html"><span class="doc">NVS Encryption</span></a> deals with this and is suitable for many uses.</p></li>
<li><p>Flash encryption alone may not prevent an attacker from modifying the firmware of the device. To prevent unauthorised firmware from running on the device, use flash encryption in combination with <a class="reference internal" href="secure-boot-v2.html"><span class="doc">Secure Boot</span></a>.</p></li>
</ul>
</p>
</section>
<section id="flash-encryption-and-secure-boot">
<span id="id3"></span><h2>Flash Encryption and Secure Boot<a class="headerlink" href="#flash-encryption-and-secure-boot" title="Permalink to this heading"></a></h2>
<p>It is recommended to use flash encryption in combination with Secure Boot. However, if Secure Boot is enabled, additional restrictions apply to device re-flashing:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#updating-encrypted-flash-ota"><span class="std std-ref">OTA Updates</span></a> are not restricted, provided that the new app is signed correctly with the Secure Boot signing key.</p></li>
</ul>
<ul class="simple">
<li><p><a class="reference internal" href="#updating-encrypted-flash-serial"><span class="std std-ref">Plaintext serial flash updates</span></a> are only possible if the <a class="reference internal" href="../api-reference/kconfig.html#config-secure-bootloader-mode"><span class="std std-ref">Re-flashable</span></a> Secure Boot mode is selected and a Secure Boot key was pre-generated and burned to the ESP32 (refer to <a class="reference internal" href="secure-boot-v1.html#secure-boot-reflashable"><span class="std std-ref">Secure Boot</span></a>). In such configuration, <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">bootloader</span></code> will produce a pre-digested bootloader and secure boot digest file for flashing at offset 0x0. When following the plaintext serial re-flashing steps it is necessary to re-flash this file before flashing other plaintext data.</p></li>
<li><p><a class="reference internal" href="#pregenerated-flash-encryption-key"><span class="std std-ref">Re-flashing via Pregenerated Flash Encryption Key</span></a> is still possible, provided the bootloader is not re-flashed. Re-flashing the bootloader requires the same <a class="reference internal" href="../api-reference/kconfig.html#config-secure-bootloader-mode"><span class="std std-ref">Re-flashable</span></a> option to be enabled in the Secure Boot config.</p></li>
</ul>
</section>
<section id="advanced-features">
<span id="flash-encryption-advanced-features"></span><h2>Advanced Features<a class="headerlink" href="#advanced-features" title="Permalink to this heading"></a></h2>
<p>The following section covers advanced features of flash encryption.</p>
<section id="encrypted-partition-flag">
<span id="id4"></span><h3>Encrypted Partition Flag<a class="headerlink" href="#encrypted-partition-flag" title="Permalink to this heading"></a></h3>
<p>Some partitions are encrypted by default. Other partitions can be marked in the partition table description as requiring encryption by adding the flag <code class="docutils literal notranslate"><span class="pre">encrypted</span></code> to the partitions' flag field. As a result, data in these marked partitions will be treated as encrypted in the same manner as an app partition.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Name,   Type, SubType, Offset,  Size, Flags</span>
nvs,<span class="w">      </span>data,<span class="w"> </span>nvs,<span class="w">     </span>0x9000,<span class="w">  </span>0x6000
phy_init,<span class="w"> </span>data,<span class="w"> </span>phy,<span class="w">     </span>0xf000,<span class="w">  </span>0x1000
factory,<span class="w">  </span>app,<span class="w">  </span>factory,<span class="w"> </span>0x10000,<span class="w"> </span>1M
secret_data,<span class="w"> </span>0x40,<span class="w"> </span>0x01,<span class="w"> </span>0x20000,<span class="w"> </span>256K,<span class="w"> </span>encrypted
</pre></div>
</div>
<p>For details on partition table description, see <a class="reference internal" href="../api-guides/partition-tables.html"><span class="doc">partition table</span></a>.</p>
<p>Further information about encryption of partitions:</p>
<ul class="simple">
<li><p>Default partition tables do not include any encrypted data partitions.</p></li>
<li><p>With flash encryption enabled, the <code class="docutils literal notranslate"><span class="pre">app</span></code> partition is always treated as encrypted and does not require marking.</p></li>
<li><p>If flash encryption is not enabled, the flag &quot;encrypted&quot; has no effect.</p></li>
<li><p>You can also consider protecting <code class="docutils literal notranslate"><span class="pre">phy_init</span></code> data from physical access, readout, or modification, by marking the optional <code class="docutils literal notranslate"><span class="pre">phy</span></code> partition with the flag <code class="docutils literal notranslate"><span class="pre">encrypted</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">nvs</span></code> partition cannot be encrypted, because the NVS library is not directly compatible with flash encryption.</p></li>
</ul>
</section>
<section id="enabling-uart-bootloader-encryption-decryption">
<span id="uart-bootloader-encryption"></span><h3>Enabling UART Bootloader Encryption/Decryption<a class="headerlink" href="#enabling-uart-bootloader-encryption-decryption" title="Permalink to this heading"></a></h3>
<p>On the first boot, the flash encryption process burns by default the following eFuses:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DISABLE_DL_ENCRYPT</span></code> which disables flash encryption operation when running in UART bootloader boot mode.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DISABLE_DL_DECRYPT</span></code> which disables transparent flash decryption when running in UART bootloader mode, even if the eFuse <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CNT</span></code> is set to enable it in normal operation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DISABLE_DL_CACHE</span></code> which disables the entire MMU flash cache when running in UART bootloader mode.</p></li>
</ul>
<p>However, before the first boot you can choose to keep any of these features enabled by burning only selected eFuses and write-protect the rest of eFuses with unset value 0. For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py<span class="w"> </span>--port<span class="w"> </span>PORT<span class="w"> </span>efuse-burn<span class="w"> </span>DISABLE_DL_DECRYPT
idf.py<span class="w"> </span>--port<span class="w"> </span>PORT<span class="w"> </span>efuse-write-protect<span class="w"> </span>DISABLE_DL_ENCRYPT
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Leaving <code class="docutils literal notranslate"><span class="pre">DISABLE_DL_DECRYPT</span></code> unset (0) makes flash encryption useless.</p>
<p>An attacker with physical access to the chip can use UART bootloader mode with custom stub code to read out the flash contents.</p>
</div>
</section>
<section id="setting-flash-crypt-config">
<span id="id5"></span><h3>Setting FLASH_CRYPT_CONFIG<a class="headerlink" href="#setting-flash-crypt-config" title="Permalink to this heading"></a></h3>
<p>The eFuse <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CONFIG</span></code> determines the number of bits in the flash encryption key which are &quot;tweaked&quot; with the block offset. For details, see <a class="reference internal" href="#flash-encryption-algorithm"><span class="std std-ref">Flash Encryption Algorithm</span></a>.</p>
<p>On the first boot of the second stage bootloader, this value is set to the maximum <code class="docutils literal notranslate"><span class="pre">0xF</span></code>.</p>
<p>It is possible to burn this eFuse manually and write protect it before the first boot in order to select different tweak values. However, this is not recommended.</p>
<p>It is strongly recommended to never write-protect <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CONFIG</span></code> when it is unset. Otherwise, its value will remain zero permanently, and no bits in the flash encryption key will be tweaked. As a result, the flash encryption algorithm will be equivalent to AES ECB mode.</p>
</section>
<section id="jtag-debugging">
<h3>JTAG Debugging<a class="headerlink" href="#jtag-debugging" title="Permalink to this heading"></a></h3>
<p>By default, when Flash Encryption is enabled (in either Development or Release mode) then JTAG debugging is disabled via eFuse. The bootloader does this on first boot, at the same time it enables flash encryption.</p>
<p>See <a class="reference internal" href="../api-guides/jtag-debugging/tips-and-quirks.html#jtag-debugging-security-features"><span class="std std-ref">JTAG with Flash Encryption or Secure Boot</span></a> for more information about using JTAG Debugging with Flash Encryption.</p>
</section>
<section id="manually-encrypting-files">
<span id="manual-encryption"></span><h3>Manually Encrypting Files<a class="headerlink" href="#manually-encrypting-files" title="Permalink to this heading"></a></h3>
<p>Manually encrypting or decrypting files requires the flash encryption key to be pre-burned in eFuse (see <a class="reference internal" href="#pregenerated-flash-encryption-key"><span class="std std-ref">Using Host Generated Key</span></a>) and a copy to be kept on the host. If the flash encryption is configured in Development Mode then it is not necessary to keep a copy of the key or follow these steps, the simpler <a class="reference internal" href="#encrypt-partitions"><span class="std std-ref">Re-flashing Updated Partitions</span></a> steps can be used.</p>
<p>The key file should be a single raw binary file (example: <code class="docutils literal notranslate"><span class="pre">key.bin</span></code>).</p>
<p>For example, these are the steps to encrypt the file <code class="docutils literal notranslate"><span class="pre">my-app.bin</span></code> to flash at offset 0x10000. Run <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>idf.py<span class="w"> </span>secure-encrypt-flash-data<span class="w"> </span>--keyfile<span class="w"> </span>/path/to/key.bin<span class="w"> </span>--address<span class="w"> </span>0x10000<span class="w"> </span>--output<span class="w"> </span>my-app-ciphertext.bin<span class="w"> </span>my-app.bin
</pre></div>
</div>
<p>The file <code class="docutils literal notranslate"><span class="pre">my-app-ciphertext.bin</span></code> can then be flashed to offset 0x10000 using <code class="docutils literal notranslate"><span class="pre">esptool.py</span></code>. To see all of the command line options recommended for <code class="docutils literal notranslate"><span class="pre">esptool.py</span></code>, see the output printed when <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">build</span></code> succeeds.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the flashed ciphertext file is not recognized by the ESP32 when it boots, check that the keys match and that the command line arguments match exactly, including the correct offset.</p>
<p>If your ESP32 uses non-default <a class="reference internal" href="#setting-flash-crypt-config"><span class="std std-ref">FLASH_CRYPT_CONFIG value in eFuse</span></a> then you will need to pass the <code class="docutils literal notranslate"><span class="pre">--flash-crypt-conf</span></code> argument to <code class="docutils literal notranslate"><span class="pre">idf.py</span></code> command to set the matching value. This will not happen if the device configured flash encryption by itself, but may happen if burning eFuses manually to enable flash encryption.</p>
</div>
<p>The command <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">decrypt-flash-data</span></code> can be used with the same options (and different input/output files), to decrypt ciphertext flash contents or a previously encrypted file.</p>
</section>
</section>
<section id="technical-details">
<h2>Technical Details<a class="headerlink" href="#technical-details" title="Permalink to this heading"></a></h2>
<p>The following sections provide some reference information about the operation of flash encryption.</p>
<section id="flash-encryption-algorithm">
<span id="id6"></span><h3>Flash Encryption Algorithm<a class="headerlink" href="#flash-encryption-algorithm" title="Permalink to this heading"></a></h3>
<ul>
<li><p>AES-256 operates on 16-byte blocks of data. The flash encryption engine encrypts and decrypts data in 32-byte blocks - two AES blocks in series.</p></li>
<li><p>The main flash encryption key is stored in the <code class="docutils literal notranslate"><span class="pre">flash_encryption</span></code> eFuse and, by default, is protected from further writes or software readout.</p></li>
<li><p>AES-256 key size is 256 bits (32 bytes) read from the <code class="docutils literal notranslate"><span class="pre">flash_encryption</span></code> eFuse. The hardware AES engine uses the key in reversed byte order as compared to the storage order in <code class="docutils literal notranslate"><span class="pre">flash_encryption</span></code>.</p>
<ul class="simple">
<li><p>If the <code class="docutils literal notranslate"><span class="pre">CODING_SCHEME</span></code> eFuse is set to <code class="docutils literal notranslate"><span class="pre">0</span></code> (default, &quot;None&quot; Coding Scheme) then the eFuse key block is 256 bits and the key is stored as-is (in reversed byte order).</p></li>
<li><p>If the <code class="docutils literal notranslate"><span class="pre">CODING_SCHEME</span></code> eFuse is set to <code class="docutils literal notranslate"><span class="pre">1</span></code> (3/4 Encoding) then the eFuse key block is 192 bits (in reversed byte order), so overall entropy is reduced. The hardware flash encryption still operates on a 256-bit key, after being read (and un-reversed), the key is extended as <code class="docutils literal notranslate"><span class="pre">key</span> <span class="pre">=</span> <span class="pre">key[0:255]</span> <span class="pre">+</span> <span class="pre">key[64:127]</span></code>.</p></li>
</ul>
</li>
<li><p>AES algorithm is used inverted in flash encryption, so the flash encryption &quot;encrypt&quot; operation is AES decrypt and the &quot;decrypt&quot; operation is AES encrypt. This is for performance reasons and does not alter the efficiency of the algorithm.</p></li>
<li><p>Each 32-byte block (two adjacent 16-byte AES blocks) is encrypted with a unique key. The key is derived from the main flash encryption key in <code class="docutils literal notranslate"><span class="pre">flash_encryption</span></code>, XORed with the offset of this block in the flash (a &quot;key tweak&quot;).</p></li>
<li><p>The specific tweak depends on the <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CONFIG</span></code> eFuse setting. This is a 4-bit eFuse where each bit enables XORing of a particular range of the key bits:</p>
<ul class="simple">
<li><p>Bit 1, bits 0-66 of the key are XORed.</p></li>
<li><p>Bit 2, bits 67-131 of the key are XORed.</p></li>
<li><p>Bit 3, bits 132-194 of the key are XORed.</p></li>
<li><p>Bit 4, bits 195-256 of the key are XORed.</p></li>
</ul>
<p>It is recommended that <code class="docutils literal notranslate"><span class="pre">FLASH_CRYPT_CONFIG</span></code> is always left at the default value <code class="docutils literal notranslate"><span class="pre">0xF</span></code>, so that all key bits are XORed with the block offset. For details, see <a class="reference internal" href="#setting-flash-crypt-config"><span class="std std-ref">Setting FLASH_CRYPT_CONFIG</span></a>.</p>
</li>
<li><p>The high 19 bits of the block offset (bit 5 to bit 23) are XORed with the main flash encryption key. This range is chosen for two reasons: the maximum flash size is 16MB (24 bits), and each block is 32 bytes so the least significant 5 bits are always zero.</p></li>
<li><p>There is a particular mapping from each of the 19 block offset bits to the 256 bits of the flash encryption key to determine which bit is XORed with which. See the variable <code class="docutils literal notranslate"><span class="pre">_FLASH_ENCRYPTION_TWEAK_PATTERN</span></code> in the <code class="docutils literal notranslate"><span class="pre">espsecure.py</span></code> source code for complete mapping.</p></li>
<li><p>To see the full flash encryption algorithm implemented in Python, refer to the <code class="docutils literal notranslate"><span class="pre">_flash_encryption_operation()</span></code> function in the <code class="docutils literal notranslate"><span class="pre">espsecure.py</span></code> source code.</p></li>
</ul>
</section>
</section>
</section>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

           </div>
             <div class="articleComments">

<style>
    .expand-feedback-content {
        display: none;
    }
    .click-like-or-dislike {
        background-color: #d3d3d3;
        pointer-events: none;
    }
</style>

<script>
    function submitFeedbackForm(user_likes_document) {
        // Send to GA4 the user reaction
        gtag('event', 'user_reaction', {
            'user_likes_document': user_likes_document
        });

        if (user_likes_document === 1) {
            document.querySelector('.like-btn').classList.add('click-like-or-dislike');
            document.getElementById("expandContentLike").style.display = 'block';
        } else {
            document.querySelector('.dislike-btn').classList.add('click-like-or-dislike');
            document.getElementById("expandContent").style.display = 'block';
        }

        document.querySelector('.like-btn').style.pointerEvents = 'none';
        document.querySelector('.dislike-btn').style.pointerEvents = 'none';
    }
</script>

<hr>

<p style="text-align:center"><strong>Was this page helpful?</strong></p>
<p style="text-align:center">
    <button class="like-btn" onclick="submitFeedbackForm(1)">
        <svg aria-hidden="true" focusable="false" class="color-fg-muted" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" style="display:inline-block;user-select:none;vertical-align:text-bottom;overflow:visible">
            <path d="M8.834.066c.763.087 1.5.295 2.01.884.505.581.656 1.378.656 2.3 0 .467-.087 1.119-.157 1.637L11.328 5h1.422c.603 0 1.174.085 1.668.333.508.254.911.679 1.137 1.2.453.998.438 2.447.188 4.316l-.04.306c-.105.79-.195 1.473-.313 2.033-.131.63-.315 1.209-.668 1.672C13.97 15.847 12.706 16 11 16c-1.848 0-3.234-.333-4.388-.653-.165-.045-.323-.09-.475-.133-.658-.186-1.2-.34-1.725-.415A1.75 1.75 0 0 1 2.75 16h-1A1.75 1.75 0 0 1 0 14.25v-7.5C0 5.784.784 5 1.75 5h1a1.75 1.75 0 0 1 1.514.872c.258-.105.59-.268.918-.508C5.853 4.874 6.5 4.079 6.5 2.75v-.5c0-1.202.994-2.337 2.334-2.184ZM4.5 13.3c.705.088 1.39.284 2.072.478l.441.125c1.096.305 2.334.598 3.987.598 1.794 0 2.28-.223 2.528-.549.147-.193.276-.505.394-1.07.105-.502.188-1.124.295-1.93l.04-.3c.25-1.882.189-2.933-.068-3.497a.921.921 0 0 0-.442-.48c-.208-.104-.52-.174-.997-.174H11c-.686 0-1.295-.577-1.206-1.336.023-.192.05-.39.076-.586.065-.488.13-.97.13-1.328 0-.809-.144-1.15-.288-1.316-.137-.158-.402-.304-1.048-.378C8.357 1.521 8 1.793 8 2.25v.5c0 1.922-.978 3.128-1.933 3.825a5.831 5.831 0 0 1-1.567.81ZM2.75 6.5h-1a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h1a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
        </svg>
    </button>
    <button class="dislike-btn" onclick="submitFeedbackForm(0)">
        <svg aria-hidden="true" focusable="false" class="" viewBox="0 0 16 16" width="16" height="16" fill="currentColor" style="display:inline-block;user-select:none;vertical-align:text-bottom;overflow:visible">
            <path d="M7.083 15.986c-.763-.087-1.499-.295-2.011-.884-.504-.581-.655-1.378-.655-2.299 0-.468.087-1.12.157-1.638l.015-.112H3.167c-.603 0-1.174-.086-1.669-.334a2.415 2.415 0 0 1-1.136-1.2c-.454-.998-.438-2.447-.188-4.316l.04-.306C.32 4.108.41 3.424.526 2.864c.132-.63.316-1.209.669-1.672C1.947.205 3.211.053 4.917.053c1.848 0 3.234.332 4.388.652l.474.133c.658.187 1.201.341 1.726.415a1.75 1.75 0 0 1 1.662-1.2h1c.966 0 1.75.784 1.75 1.75v7.5a1.75 1.75 0 0 1-1.75 1.75h-1a1.75 1.75 0 0 1-1.514-.872c-.259.105-.59.268-.919.508-.671.491-1.317 1.285-1.317 2.614v.5c0 1.201-.994 2.336-2.334 2.183Zm4.334-13.232c-.706-.089-1.39-.284-2.072-.479l-.441-.125c-1.096-.304-2.335-.597-3.987-.597-1.794 0-2.28.222-2.529.548-.147.193-.275.505-.393 1.07-.105.502-.188 1.124-.295 1.93l-.04.3c-.25 1.882-.19 2.933.067 3.497a.923.923 0 0 0 .443.48c.208.104.52.175.997.175h1.75c.685 0 1.295.577 1.205 1.335-.022.192-.049.39-.075.586-.066.488-.13.97-.13 1.329 0 .808.144 1.15.288 1.316.137.157.401.303 1.048.377.307.035.664-.237.664-.693v-.5c0-1.922.978-3.127 1.932-3.825a5.878 5.878 0 0 1 1.568-.809Zm1.75 6.798h1a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25h-1a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25Z"></path>
        </svg>
    </button>
</p>

<div class="expand-feedback-content" id="expandContentLike">
    <ul style="text-align:center">
        <li>Thank you! We received your feedback.</li>
        <li>If you have any comments, fill in <a href='https://www.espressif.com/en/company/documents/documentation_feedback?docId=4287&sections=Flash Encryption (security/flash-encryption)&version=esp32 v5.4.2 (v5.4.2)'>Espressif Documentation Feedback Form</a>.</li>
    </ul>
</div>

<div class="expand-feedback-content" id="expandContent">
    <ul style="text-align:center">
        <li>We value your feedback.</li>
        <li>Let us know how we can improve this page by filling in <a href='https://www.espressif.com/en/company/documents/documentation_feedback?docId=4287&sections=Flash Encryption (security/flash-encryption)&version=esp32 v5.4.2 (v5.4.2)'>Espressif Documentation Feedback Form</a>.</li>
    </ul>
</div>

<br>


             </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="security.html" class="btn btn-neutral float-left" title="Security Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="secure-boot-v1.html" class="btn btn-neutral float-right" title="Secure Boot" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016 - 2025, Espressif Systems (Shanghai) Co., Ltd.</p>
  </div>

  <ul class="footer">
        <li>
	    
            
            Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/espressif/sphinx_idf_theme">theme</a>  based on <a href="https://github.com/readthedocs/sphinx_rtd_theme">Read the Docs Sphinx Theme</a>.
         </li>
    <li class="footer-aside">
        <a href="../esp-idf-en-v5.4.2.zip"> Download HTML</a>
    </li>

  </ul> 

</footer>
        </div>
      </div>
    </section>
  </div>

  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>